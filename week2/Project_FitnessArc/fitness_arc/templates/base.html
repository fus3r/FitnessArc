<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Fitness Arc{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#6366f1;--secondary:#8b5cf6;--accent:#ec4899;
      --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --bg:#0a0a0f;--bg-elevated:#12121a;--bg-card:#1a1a24;
      --text:#e5e7eb;--text-dim:#9ca3af;--border:#1f2937;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-20px)}}
    @keyframes rotate{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @keyframes navGlow{
      0%,100%{opacity:0.3;filter:brightness(1) hue-rotate(0deg)}
      25%{opacity:0.6;filter:brightness(1.3) hue-rotate(15deg)}
      50%{opacity:0.4;filter:brightness(1.1) hue-rotate(30deg)}
      75%{opacity:0.6;filter:brightness(1.3) hue-rotate(15deg)}
    }
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#0a0a0f 0%,#1a0f2e 25%,#0f1a2e 50%,#0a0a0f 100%);
      background-size:400% 400%;
      animation:fadeIn 0.4s ease;
      color:var(--text);min-height:100vh;font-size:15px;line-height:1.6;
      -webkit-font-smoothing:antialiased;position:relative;overflow-x:hidden;
    }
    body::before{
      content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;
      background:
        radial-gradient(circle at 20% 30%,rgba(99,102,241,0.15),transparent 25%),
        radial-gradient(circle at 80% 70%,rgba(139,92,246,0.12),transparent 25%),
        radial-gradient(circle at 50% 50%,rgba(236,72,153,0.08),transparent 30%);
      pointer-events:none;z-index:0;
      animation:rotate 60s linear infinite;
    }
    body::after{
      content:'';position:fixed;top:0;left:0;right:0;bottom:0;
      background:
        linear-gradient(45deg,transparent 30%,rgba(99,102,241,0.03) 50%,transparent 70%),
        linear-gradient(-45deg,transparent 30%,rgba(139,92,246,0.03) 50%,transparent 70%);
      background-size:200% 200%;
      pointer-events:none;z-index:0;
      animation:float 15s ease-in-out infinite;
    }
    header{
      background:rgba(18,18,26,0.85);
      backdrop-filter:blur(30px) saturate(180%);
      border-bottom:2px solid transparent;
      border-image:linear-gradient(90deg, 
                    transparent 0%,
                    rgba(99,102,241,0.3) 10%,
                    rgba(168,85,247,0.5) 30%,
                    rgba(236,72,153,0.5) 50%,
                    rgba(168,85,247,0.5) 70%,
                    rgba(99,102,241,0.3) 90%,
                    transparent 100%) 1;
      position:fixed;top:0;left:0;right:0;z-index:100;
      box-shadow:0 8px 32px rgba(0,0,0,0.4),
                 0 0 60px rgba(99,102,241,0.15),
                 inset 0 1px 0 rgba(255,255,255,0.05);
      display:block;
      margin:0;
      padding:0;
    }
    header::before{
      content:'';
      display:none;
    }
    header::after{
      content:'';
      display:none;
    }
    main.container{
      margin-top:120px;
    }
    nav{
      max-width:1600px;margin:0 auto;padding:1rem 2.5rem;
      display:flex;align-items:center;justify-content:space-between;
      position:relative;z-index:1;
    }
    nav:nth-of-type(n+2){
      display:none;
    }
    .nav-brand{
      display:flex;align-items:center;gap:0.75rem;
    }
    .nav-brand-logo{
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:1.25rem;color:#fff;
      box-shadow:0 4px 12px rgba(99,102,241,0.4),
                 0 0 24px rgba(99,102,241,0.3),
                 inset 0 1px 2px rgba(255,255,255,0.3);
      position:relative;
      transition:all 0.3s ease;
    }
    .nav-brand-logo:hover{
      box-shadow:0 6px 20px rgba(99,102,241,0.6),
                 0 0 40px rgba(99,102,241,0.5),
                 inset 0 1px 3px rgba(255,255,255,0.4);
      transform:scale(1.05) rotateZ(-5deg);
    }
    .nav-brand-text{
      font-size:1.25rem;font-weight:800;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      background-size:200% auto;
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;letter-spacing:-0.02em;
      animation:shimmerText 3s linear infinite;
      text-shadow:0 0 20px rgba(99,102,241,0.3);
    }
    @keyframes shimmerText{
      0%{background-position:0% center}
      100%{background-position:200% center}
    }
    .nav-center{
      display:flex;align-items:center;gap:0.5rem;
      background:rgba(26,26,36,0.6);padding:0.5rem;
      border-radius:50px;border:1px solid rgba(99,102,241,0.2);
    }
    .nav-center a{
      color:var(--text-dim);text-decoration:none;font-weight:500;
      font-size:14px;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      padding:0.625rem 1.25rem;border-radius:30px;white-space:nowrap;
      position:relative;overflow:hidden;
    }
    .nav-center a::before{
      content:'';position:absolute;inset:0;
      background:radial-gradient(circle at center, rgba(99,102,241,0.2), transparent 70%);
      opacity:0;transition:opacity 0.3s ease;
    }
    .nav-center a:hover::before{opacity:1}
    .nav-center a.active{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;
      box-shadow:0 4px 16px rgba(99,102,241,0.6),
                 0 0 24px rgba(99,102,241,0.3),
                 inset 0 1px 2px rgba(255,255,255,0.2);
    }
    .nav-center a:not(.active):hover{
      color:var(--text);
      background:rgba(51,65,85,0.6);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(99,102,241,0.2);
    }
    .nav-right{
      display:flex;align-items:center;gap:1rem;
    }
    .nav-friends-icon{
      position:relative;
    }
    .nav-friends-icon a{
      display:flex;align-items:center;justify-content:center;
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(51,65,85,0.8), rgba(26,26,36,0.9));
      border:2px solid rgba(99,102,241,0.3);
      transition:all 0.3s ease;text-decoration:none;
      box-shadow:0 2px 8px rgba(0,0,0,0.3),
                 inset 0 1px 2px rgba(255,255,255,0.05);
      position:relative;
    }
    .errorlist{color:var(--danger);list-style:none;margin:.25rem 0 .5rem;padding:0;font-weight:600}

    .auth-footer{
      display:flex;
      gap:.5rem;
      align-items:center;
      margin-top:.75rem;
    }
    .text-dim{ color: var(--text-dim); font-size: 0.95rem; }
    .nav-friends-icon a::before{
      content:'';position:absolute;inset:-2px;border-radius:50%;
      background:conic-gradient(from 0deg, transparent, rgba(99,102,241,0.6), transparent);
      opacity:0;transition:opacity 0.3s ease;animation:spin 3s linear infinite;
      filter:blur(4px);
    }
    .nav-friends-icon a:hover::before{opacity:1}
    .nav-friends-icon a:hover{
      border-color:rgba(99,102,241,0.6);
      box-shadow:0 4px 16px rgba(99,102,241,0.4),
                 0 0 24px rgba(99,102,241,0.2);
      transform:scale(1.05);
    }
    .nav-friends-icon svg{
      color:var(--primary);position:relative;z-index:1;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    .nav-friends-icon .pending-requests-count{
      position:absolute;top:-4px;right:-4px;
      background:var(--danger);color:#fff;
      width:18px;height:18px;border-radius:50%;
      font-size:10px;font-weight:700;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 2px 8px rgba(239,68,68,0.5);
    }
    .nav-user-dropdown{
      position:relative;
    }
    .nav-user{
      display:flex;align-items:center;gap:0.75rem;
      padding:0.5rem 1rem 0.5rem 0.5rem;
      background:radial-gradient(circle at 30% 30%, rgba(51,65,85,0.8), rgba(26,26,36,0.9));
      border-radius:50px;
      border:2px solid rgba(99,102,241,0.3);
      transition:all 0.3s ease;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.3),
                 inset 0 1px 2px rgba(255,255,255,0.05);
      position:relative;
    }
    .nav-user::before{
      content:'';position:absolute;inset:-2px;border-radius:50px;
      background:linear-gradient(135deg, rgba(99,102,241,0.6), rgba(168,85,247,0.6));
      opacity:0;transition:opacity 0.3s ease;
      filter:blur(8px);z-index:-1;
    }
    .nav-user:hover{
      border-color:rgba(99,102,241,0.6);
      box-shadow:0 6px 20px rgba(99,102,241,0.4),
                 0 0 32px rgba(99,102,241,0.2);
    }
    .nav-user:hover::before{opacity:1}
    .nav-avatar{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:14px;
      box-shadow:0 4px 12px rgba(99,102,241,0.5),
                 0 0 20px rgba(99,102,241,0.3),
                 inset 0 1px 2px rgba(255,255,255,0.3);
    }
    .nav-username{
      color:var(--text);font-size:14px;font-weight:600;
    }
    .dropdown-menu{
      position:absolute;top:calc(100% + 0.5rem);right:0;
      background:rgba(26,26,36,0.95);backdrop-filter:blur(20px);
      border:1px solid rgba(99,102,241,0.2);border-radius:16px;
      padding:0.5rem;min-width:200px;
      box-shadow:0 12px 32px rgba(0,0,0,0.5);
      opacity:0;visibility:hidden;transform:translateY(-10px);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      z-index:1000;
    }
    .nav-user-dropdown:hover .dropdown-menu{
      opacity:1;visibility:visible;transform:translateY(0);
    }
    .dropdown-menu a,.dropdown-menu button{
      display:flex;align-items:center;gap:0.75rem;
      padding:0.75rem 1rem;border-radius:12px;
      color:var(--text);text-decoration:none;
      font-size:14px;font-weight:500;
      transition:all 0.2s;width:100%;
      background:none;border:none;cursor:pointer;
      font-family:inherit;text-align:left;
    }
    .dropdown-menu a:hover{
      background:rgba(99,102,241,0.15);
      color:var(--primary);
    }
    .dropdown-menu button:hover{
      background:rgba(239,68,68,0.15);
      color:var(--danger);
    }
    .dropdown-divider{
      height:1px;background:rgba(99,102,241,0.1);
      margin:0.5rem 0;
    }
    .container{
      max-width:1600px;margin:2rem auto;padding:0 2.5rem;
      position:relative;z-index:1;animation:slideIn 0.5s ease;
    }
    .card{
      background:rgba(26,26,36,0.5);backdrop-filter:blur(20px);
      border:1px solid rgba(99,102,241,0.15);border-radius:20px;
      padding:2rem;margin:1.5rem 0;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      position:relative;overflow:visible;
    }
    .card::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(99,102,241,0.05),transparent);
      transition:left 0.6s;
    }
    .card:hover{
      border-color:rgba(99,102,241,0.3);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      transform:translateY(-4px);
    }
    .card:hover::before{left:100%}
    input,select,textarea{
      font:inherit;padding:0.875rem 1.25rem;
      border:1px solid rgba(99,102,241,0.2);
      border-radius:12px;background:rgba(18,18,26,0.6);
      color:var(--text);transition:all 0.2s;width:100%;margin:0.5rem 0;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(99,102,241,0.15);
      background:rgba(18,18,26,0.9);
    }
    /* Custom Select Dropdowns */
    .custom-select{position:relative;display:block;width:100%;margin:0.5rem 0;z-index:1}
    .custom-select.open{z-index:9998}
    .custom-select select{display:none !important}
    .custom-select-trigger{
      background:rgba(18,18,26,0.8);border:1px solid rgba(99,102,241,0.3);
      border-radius:12px;padding:0.875rem 2.5rem 0.875rem 1.25rem;
      cursor:pointer;transition:all 0.2s;color:var(--text);
      font-size:15px;display:flex;align-items:center;
      justify-content:space-between;position:relative;width:100%;
    }
    .custom-select-trigger:hover{
      border-color:var(--primary);background:rgba(18,18,26,0.9);
    }
    .custom-select-arrow{
      position:absolute;right:1rem;top:50%;
      transform:translateY(-50%);pointer-events:none;
      transition:transform 0.3s;width:0;height:0;
      border-left:5px solid transparent;border-right:5px solid transparent;
      border-top:6px solid var(--text-dim);
    }
    .custom-select.open .custom-select-arrow{
      transform:translateY(-50%) rotate(180deg);
    }
    .custom-select-dropdown{
      position:absolute;top:calc(100% + 0.5rem);left:0;right:0;
      background:rgba(26,26,36,0.95);backdrop-filter:blur(20px);
      border:1px solid rgba(99,102,241,0.3);border-radius:12px;
      max-height:300px;overflow-y:auto;
      opacity:0;visibility:hidden;display:block;
      transform:translateY(-10px);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      z-index:9999;box-shadow:0 12px 32px rgba(0,0,0,0.5);
      pointer-events:none;
    }
    .custom-select.open .custom-select-dropdown{
      opacity:1 !important;
      visibility:visible !important;
      transform:translateY(0) !important;
      pointer-events:auto !important;
    }
    /* Custom scrollbar for dropdown */
    .custom-select-dropdown::-webkit-scrollbar{width:8px}
    .custom-select-dropdown::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:10px}
    .custom-select-dropdown::-webkit-scrollbar-thumb{background:rgba(99,102,241,0.5);border-radius:10px}
    .custom-select-dropdown::-webkit-scrollbar-thumb:hover{background:rgba(99,102,241,0.7)}
    .custom-select-option{
      padding:0.75rem 1rem;cursor:pointer;transition:all 0.2s;
      color:var(--text);font-size:14px;
    }
    .custom-select-option:hover{
      background:rgba(99,102,241,0.15);color:var(--primary);
    }
    .custom-select-option.selected{
      background:rgba(99,102,241,0.2);color:var(--primary);font-weight:600;
    }
    .custom-select-search{
      padding:0.75rem 1rem;border-bottom:1px solid rgba(99,102,241,0.15);
      position:sticky;top:0;background:rgba(26,26,36,0.98);
      backdrop-filter:blur(20px);z-index:1;
    }
    .custom-select-search input{
      margin:0;padding:0.5rem 0.75rem;font-size:13px;
      background:rgba(18,18,26,0.7);
      border:1px solid rgba(99,102,241,0.2);
    }
    
    button:not(.nav-center a):not(.dropdown-menu button),.btn{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;border:none;cursor:pointer;
      padding:0.625rem 1.25rem;
      border-radius:8px;text-decoration:none;display:inline-block;
      font-weight:500;font-size:13px;transition:all 0.2s;
      font-family:inherit;position:relative;overflow:hidden;
      box-shadow:0 2px 8px rgba(99,102,241,0.25);
    }
    button:not(.nav-center a):not(.dropdown-menu button)::after,.btn::after{
      content:'';position:absolute;top:50%;left:50%;width:0;height:0;
      border-radius:50%;background:rgba(255,255,255,0.2);
      transition:width 0.4s,height 0.4s;transform:translate(-50%,-50%);
    }
    button:not(.nav-center a):not(.dropdown-menu button):hover::after,.btn:hover::after{width:300px;height:300px}
    button:not(.nav-center a):not(.dropdown-menu button):hover,.btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(99,102,241,0.35);
    }
    .btn-secondary{
      background:rgba(71,85,105,0.8);
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .btn-secondary:hover{
      background:rgba(71,85,105,0.9);
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .btn-danger{
      background:linear-gradient(135deg,var(--danger),#dc2626);
      box-shadow:0 2px 8px rgba(239,68,68,0.25);
    }
    .actions{
  display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; margin-top:.75rem;
    }
    .btn-ghost{
      background:transparent;
      color:var(--text);
      border:1px solid rgba(255,255,255,.15);
    }
    .btn-ghost:hover{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.35);
    }

    table{
      width:100%;border-collapse:separate;border-spacing:0;
      margin:1.5rem 0;border-radius:16px;overflow:hidden;
    }
    th,td{padding:1.125rem;text-align:left;border-bottom:1px solid rgba(99,102,241,0.1)}
    th{
      background:rgba(99,102,241,0.08);color:var(--text);font-weight:700;
      font-size:12px;text-transform:uppercase;letter-spacing:0.08em;
    }
    tr:hover td{background:rgba(99,102,241,0.05)}
    .item-card{
      background:rgba(26,26,36,0.4);
      border:1px solid rgba(99,102,241,0.15);
      border-radius:16px;padding:1.75rem;margin:1rem 0;
      transition:all 0.3s;
    }
    .item-card:hover{
      border-color:rgba(99,102,241,0.4);
      box-shadow:0 12px 32px rgba(0,0,0,0.4);
      transform:translateY(-3px);
    }
    h1{
      font-size:2.75rem;font-weight:900;letter-spacing:-0.04em;
      margin-bottom:0.75rem;color:var(--text);
    }
    h2{font-size:2rem;font-weight:800;margin-bottom:1rem;color:var(--text)}
    h3{font-size:1.5rem;font-weight:700;margin-bottom:0.75rem;color:var(--text)}
    h4{font-size:1.25rem;font-weight:600;margin-bottom:0.5rem;color:var(--text)}
    p{color:var(--text-dim);line-height:1.7}
    label{
      display:block;color:var(--text);font-weight:600;
      font-size:13px;margin-bottom:0.5rem;letter-spacing:0.02em;
    }
    .messages{list-style:none;padding:0}
    .messages li{
      background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.08));
      border:1px solid rgba(16,185,129,0.3);border-left:4px solid var(--success);
      padding:1.125rem 1.5rem;border-radius:12px;margin:1rem 0;
      animation:slideIn 0.4s ease;font-weight:500;
    }
    .badge{
      display:inline-block;padding:0.5rem 1rem;border-radius:20px;
      font-size:12px;font-weight:700;letter-spacing:0.03em;
    }
    .badge-primary{
      background:rgba(99,102,241,0.2);color:var(--primary);
      border:1px solid rgba(99,102,241,0.3);
    }
    .badge-warning{
      background:rgba(245,158,11,0.2);color:var(--warning);
      border:1px solid rgba(245,158,11,0.3);
    }
    .stat-card{
      text-align:center;padding:2.5rem;border-radius:20px;
      transition:all 0.4s;position:relative;overflow:hidden;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    .stat-card::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.05);opacity:0;transition:opacity 0.3s;
    }
    .stat-card:hover::before{opacity:1}
    .stat-card:hover{
      transform:translateY(-8px);
      box-shadow:0 24px 48px rgba(0,0,0,0.6);
    }
    .meal-group{
      background:rgba(26,26,36,0.4);
      border:1px solid rgba(99,102,241,0.15);
      border-radius:20px;padding:2rem;margin:1.5rem 0;
      transition:all 0.2s;
    }
    .meal-group:hover{border-color:rgba(99,102,241,0.3)}
    .meal-group h4{
      color:var(--text);font-size:1.25rem;font-weight:700;
      margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem;
    }
    @media(max-width:1024px){
      .nav-center{flex-wrap:wrap;justify-content:center}
      .nav-brand{display:none}
    }
    @media(max-width:768px){
      nav{flex-direction:column;gap:1rem;padding:1rem}
      .nav-center{width:100%}
      .container{padding:0 1rem;margin:1.5rem auto}
      h1{font-size:2rem}
      .card{padding:1.5rem}
    }
  </style>
  <script>
  // Custom Dropdown Component - Défini dans le HEAD pour être disponible partout
  class CustomSelect {
    constructor(element, options = {}) {
      this.element = element;
      this.options = options;
      this.selectedValue = options.defaultValue || '';
      this.searchable = options.searchable || element.hasAttribute('data-searchable');
      this.onChange = options.onChange || (() => {});
      
      // Ajouter un attribut pour tracking
      this.element.setAttribute('data-custom-select-status', 'initializing');
      
      this.init();
    }

    init() {
      const nativeSelect = this.element.querySelector('select');
      if (!nativeSelect) {
        this.element.setAttribute('data-custom-select-status', 'error-no-select');
        return;
      }

      // Check if already initialized
      if (this.element.querySelector('.custom-select-trigger')) {
        this.element.setAttribute('data-custom-select-status', 'already-initialized');
        return;
      }

      this.nativeSelect = nativeSelect;
      this.selectedValue = nativeSelect.value;

      // Create custom dropdown HTML
      const customHTML = this.createCustomHTML();
      this.element.insertAdjacentHTML('beforeend', customHTML);

      // Get references
      this.trigger = this.element.querySelector('.custom-select-trigger');
      this.dropdown = this.element.querySelector('.custom-select-dropdown');
      this.arrow = this.element.querySelector('.custom-select-arrow');
      this.optionsContainer = this.element.querySelector('.custom-select-options');

      if (!this.trigger || !this.dropdown || !this.optionsContainer) {
        this.element.setAttribute('data-custom-select-status', 'error-missing-elements');
        return;
      }

      // Hide native select
      nativeSelect.style.display = 'none';

      // Bind events
      this.bindEvents();
      
      // Marquer comme initialisé avec succès
      this.element.setAttribute('data-custom-select-status', 'initialized');
      this.element.classList.add('custom-select-ready');
    }

    createCustomHTML() {
      const options = Array.from(this.nativeSelect.options);
      const selectedOption = options.find(opt => opt.value === this.selectedValue);
      const selectedText = selectedOption ? selectedOption.text : options[0]?.text || 'Sélectionner...';

      let searchHTML = '';
      if (this.searchable) {
        searchHTML = `
          <div class="custom-select-search">
            <input type="text" placeholder="Rechercher..." class="custom-select-search-input" autocomplete="off">
          </div>
        `;
      }

      const optionsHTML = options.map(opt => `
        <div class="custom-select-option ${opt.value === this.selectedValue ? 'selected' : ''}" data-value="${opt.value}">
          ${opt.text}
        </div>
      `).join('');

      return `
        <div class="custom-select-trigger">
          <span class="custom-select-label">${selectedText}</span>
          <span class="custom-select-arrow"></span>
        </div>
        <div class="custom-select-dropdown">
          ${searchHTML}
          <div class="custom-select-options">
            ${optionsHTML}
          </div>
        </div>
      `;
    }

    bindEvents() {
      // Toggle dropdown
      this.trigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.toggle();
      });

      // Select option
      this.optionsContainer.addEventListener('click', (e) => {
        const option = e.target.closest('.custom-select-option');
        if (option) {
          this.selectOption(option);
        }
      });

      // Search functionality
      if (this.searchable) {
        const searchInput = this.element.querySelector('.custom-select-search-input');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            this.filterOptions(e.target.value);
          });
          searchInput.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
      }

      // Close on outside click
      const closeHandler = (e) => {
        if (!this.element.contains(e.target)) {
          this.close();
        }
      };
      document.addEventListener('click', closeHandler);
      
      // Store handler for cleanup if needed
      this.closeHandler = closeHandler;

      // Keyboard navigation
      this.element.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') this.close();
      });
    }

    toggle() {
      console.log('Toggle called, current state:', this.element.classList.contains('open'));
      if (this.element.classList.contains('open')) {
        this.close();
      } else {
        this.open();
      }
    }

    open() {
      console.log('Opening dropdown...');
      // Close all other custom selects
      document.querySelectorAll('.custom-select.open').forEach(sel => {
        if (sel !== this.element) sel.classList.remove('open');
      });
      
      this.element.classList.add('open');
      this.element.setAttribute('data-custom-select-state', 'open');
      console.log('Dropdown opened, classes:', this.element.className);
      
      if (this.searchable) {
        const searchInput = this.element.querySelector('.custom-select-search-input');
        setTimeout(() => searchInput?.focus(), 50);
      }
    }

    close() {
      this.element.classList.remove('open');
      this.element.setAttribute('data-custom-select-state', 'closed');
      
      if (this.searchable) {
        const searchInput = this.element.querySelector('.custom-select-search-input');
        if (searchInput) {
          searchInput.value = '';
          this.filterOptions('');
        }
      }
    }

    selectOption(optionElement) {
      const value = optionElement.dataset.value;
      this.selectedValue = value;

      // Update native select
      this.nativeSelect.value = value;

      // Trigger change event on native select
      const event = new Event('change', { bubbles: true });
      this.nativeSelect.dispatchEvent(event);

      // Update UI
      const labelElement = this.trigger.querySelector('.custom-select-label');
      if (labelElement) {
        labelElement.textContent = optionElement.textContent.trim();
      }
      
      this.optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      optionElement.classList.add('selected');

      // Call onChange callback
      this.onChange(value);

      this.close();
    }

    normalizeString(str) {
      // Supprime les accents et caractères spéciaux pour la recherche
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/œ/g, 'oe')
        .replace(/æ/g, 'ae');
    }

    filterOptions(query) {
      const options = this.optionsContainer.querySelectorAll('.custom-select-option');
      const normalizedQuery = this.normalizeString(query);
      
      options.forEach(opt => {
        const text = opt.textContent;
        const normalizedText = this.normalizeString(text);
        if (normalizedText.includes(normalizedQuery)) {
          opt.style.display = '';
        } else {
          opt.style.display = 'none';
        }
      });
    }
  }
  </script>
  {% block head %}{% endblock %}
</head>
<body>
<header>
  <nav>
    <div class="nav-brand">
      <div class="nav-brand-logo">FA</div>
      <div class="nav-brand-text">Fitness Arc</div>
    </div>
    
    <div class="nav-center">
      <a href="{% url 'common:index' %}" {% if request.resolver_match.url_name == 'index' and request.resolver_match.namespace == 'common' %}class="active"{% endif %}>Accueil</a>
      {% if user.is_authenticated %}
        <a href="{% url 'dashboard:index' %}" {% if request.resolver_match.namespace == 'dashboard' %}class="active"{% endif %}>Dashboard</a>
      {% endif %}
      {% if feature_workouts %}
      <a href="{% url 'workouts:exercise_list' %}" {% if request.resolver_match.url_name == 'exercise_list' %}class="active"{% endif %}>Exercices</a>
      <a href="{% url 'workouts:template_list' %}" {% if request.resolver_match.url_name == 'template_list' or request.resolver_match.url_name == 'template_detail' %}class="active"{% endif %}>Workouts</a>
      {% endif %}
      {% if feature_nutrition %}
      <a href="{% url 'nutrition_today' %}" {% if 'nutrition' in request.path %}class="active"{% endif %}>Nutrition</a>
      {% endif %}
      {% if feature_running %}
      <a href="{% url 'running:my_runs' %}"
          {% if request.resolver_match.namespace == 'running' %}class="active"{% endif %}>
        Running
      </a>
      {% endif %}
      {% if feature_leaderboard %}
       <a href="{% url 'leaderboard:index' %}" {% if request.resolver_match.namespace == 'leaderboard' %}class="active"{% endif %}>Leaderboard</a>
      {% endif %}
    </div>
    
    <div class="nav-right">
      {% if user.is_authenticated %}
        <!-- Friends Icon -->
        <div class="nav-friends-icon" style="position:relative">
          <a href="{% url 'accounts:friends_list' %}" style="display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;background:rgba(26,26,36,0.6);border:1px solid rgba(99,102,241,0.2);transition:all 0.2s;text-decoration:none">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--primary)">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            {% if pending_requests_count > 0 %}
            <span style="position:absolute;top:-4px;right:-4px;background:var(--danger);color:#fff;width:18px;height:18px;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(239,68,68,0.5)">
              {{ pending_requests_count }}
            </span>
            {% endif %}
          </a>
        </div>
        
        <div class="nav-user-dropdown">
          <div class="nav-user">
            <div class="nav-avatar">{{ user.username.0|upper }}</div>
            <span class="nav-username">{{ user.username }}</span>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="opacity:0.6">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          
          <div class="dropdown-menu">
            <a href="{% url 'accounts:profile' %}">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Mon Profil
            </a>
            <div class="dropdown-divider"></div>
            <form method="post" action="{% url 'accounts:logout' %}" style="margin:0">
              {% csrf_token %}
              <button type="submit">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                  <polyline points="16 17 21 12 16 7"/>
                  <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Déconnexion
              </button>
            </form>
          </div>
        </div>
      {% else %}
        <a href="{% url 'accounts:login' %}" class="btn">Connexion</a>
      {% endif %}
    </div>
  </nav>
</header>
<main class="container">
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  {% block content %}{% endblock %}
</main>
<script>
// Initialize custom selects on page load (classe définie dans le HEAD)
document.addEventListener('DOMContentLoaded', () => {
  // Attendre que le DOM soit complètement chargé
  setTimeout(() => {
    const allSelects = document.querySelectorAll('.custom-select');
    console.log(`Found ${allSelects.length} custom-select elements to initialize`);
    
    allSelects.forEach((element, index) => {
      // Check if this element is NOT inside a Vue app
      const isInVueApp = element.closest('#exerciseApp, #nutritionApp');
      
      if (!isInVueApp) {
        console.log(`Initializing dropdown ${index + 1}...`);
        // Ajouter une classe temporaire pour le debug
        element.classList.add('custom-select-processing');
        
        try {
          new CustomSelect(element);
          console.log(`✓ Dropdown ${index + 1} initialized successfully`);
        } catch (error) {
          console.error(`✗ Failed to init dropdown ${index + 1}:`, error);
          element.setAttribute('data-custom-select-status', 'error-init-failed');
          element.classList.add('custom-select-error');
        }
        
        element.classList.remove('custom-select-processing');
      } else {
        console.log(`Skipping dropdown ${index + 1} (inside Vue app)`);
      }
    });
  }, 150);
});
</script>
</body>
</html>