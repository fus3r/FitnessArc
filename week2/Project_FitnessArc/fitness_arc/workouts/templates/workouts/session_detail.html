{% extends "base.html" %}
{% block title %}S√©ance{% endblock %}
{% block content %}
<h1>S√©ance du {{ session.date }}</h1>

<!-- Chronom√®tre -->
<div class="card" style="text-align:center;margin-bottom:2rem;background:#f8f9fa">
  <h2 style="font-size:3rem;margin:1rem 0;font-weight:bold;font-family:monospace" id="timer">00:00:00</h2>
  <div>
    <button class="btn" id="pauseBtn" onclick="pauseTimer()" style="background:#ffc107">‚è∏ Pause</button>
    <button class="btn" id="resumeBtn" onclick="resumeTimer()" style="display:none">‚ñ∂Ô∏è Reprendre</button>
    <button class="btn" onclick="resetTimer()" style="background:#6c757d">üîÑ R√©initialiser</button>
  </div>
</div>

<h3>Ajouter une s√©rie</h3>
<form method="post" style="margin-bottom:1rem">
  {% csrf_token %}
  <label>Exercice :
    <select name="exercise_id" required>
      {% if session.from_template %}
        {% for item in session.from_template.items.all %}
          <option value="{{ item.exercise.id }}">{{ item.exercise.name }}</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <label>S√©rie # :
    <input type="number" name="set_number" min="1" value="{{ session.set_logs.count|add:'1' }}">
  </label>
  <label>Reps :
    <input type="number" name="reps" min="1" required>
  </label>
  <label>Poids (kg) :
    <input type="number" name="weight_kg" step="0.5" min="0" required>
  </label>
  <button type="submit" class="btn">Ajouter</button>
</form>

<h3>Logs</h3>
<table>
  <thead><tr><th>#</th><th>Exercice</th><th>Reps</th><th>Poids</th><th>Volume</th></tr></thead>
  <tbody>
    {% for s in session.set_logs.all %}
      <tr>
        <td>{{ s.set_number }}</td>
        <td>{{ s.exercise.name }}</td>
        <td>{{ s.reps }}</td>
        <td>{{ s.weight_kg }} kg</td>
        <td>{{ s.volume }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5">Aucune s√©rie pour le moment.</td></tr>
    {% endfor %}
  </tbody>
</table>

<style>
  #timer {
    color: #0b5ed7;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  }
  .card {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
</style>

<script>
let seconds = 0;
let interval = null;
let isRunning = false;

// R√©cup√©rer le temps sauvegard√© dans localStorage
const sessionKey = 'session_{{ session.pk }}_time';
const savedTime = localStorage.getItem(sessionKey);
if (savedTime) {
  seconds = parseInt(savedTime);
  updateDisplay();
}

function startTimer() {
  if (isRunning) return;
  
  isRunning = true;
  document.getElementById('pauseBtn').style.display = 'inline-block';
  document.getElementById('resumeBtn').style.display = 'none';
  
  interval = setInterval(() => {
    seconds++;
    updateDisplay();
    localStorage.setItem(sessionKey, seconds);
  }, 1000);
}

function pauseTimer() {
  isRunning = false;
  clearInterval(interval);
  document.getElementById('pauseBtn').style.display = 'none';
  document.getElementById('resumeBtn').style.display = 'inline-block';
}

function resumeTimer() {
  startTimer();
}

function resetTimer() {
  pauseTimer();
  seconds = 0;
  updateDisplay();
  localStorage.removeItem(sessionKey);
}

function updateDisplay() {
  const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
  const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
  const secs = (seconds % 60).toString().padStart(2, '0');
  document.getElementById('timer').textContent = `${hrs}:${mins}:${secs}`;
}

// Auto-d√©marrage au chargement de la page
window.addEventListener('load', () => {
  startTimer();
});
</script>
{% endblock %}
