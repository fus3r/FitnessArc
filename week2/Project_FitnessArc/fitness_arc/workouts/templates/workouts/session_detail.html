{% extends "base.html" %}
{% block title %}S√©ance{% endblock %}
{% block content %}
<h1>S√©ance du {{ session.date }}</h1>

{% if session.is_completed %}
<div style="background:#d4edda;border:1px solid #c3e6cb;padding:1rem;border-radius:8px;margin-bottom:1rem">
  ‚úÖ <strong>S√©ance termin√©e !</strong> Dur√©e : {{ session.duration_minutes }} min | Calories : {{ session.estimated_calories_burned }} kcal
  <br><a href="{% url 'workouts:session_summary' session.pk %}" class="btn" style="margin-top:0.5rem">Voir le r√©capitulatif ‚Üí</a>
</div>
{% else %}
<div class="card" style="text-align:center;margin-bottom:2rem;background:#f8f9fa">
  <h2 style="font-size:3rem;margin:1rem 0;font-weight:bold;font-family:monospace" id="timer">00:00:00</h2>
  <div>
    <button class="btn" id="pauseBtn" onclick="pauseTimer()" style="background:#ffc107">‚è∏ Pause</button>
    <button class="btn" id="resumeBtn" onclick="resumeTimer()" style="display:none">‚ñ∂Ô∏è Reprendre</button>
    <button class="btn" onclick="resetTimer()" style="background:#6c757d">üîÑ R√©initialiser</button>
  </div>
</div>

<h3>Ajouter une s√©rie</h3>
<form method="post" style="margin-bottom:1rem" id="addSetForm">
  {% csrf_token %}
  <input type="hidden" name="duration_minutes" id="duration_minutes" value="0">
  <label>Exercice :
    <div class="custom-select">
      <select name="exercise_id" required>
        {% if session.from_template %}
          {% for item in session.from_template.items.all %}
            <option value="{{ item.exercise.id }}">{{ item.exercise.name }}</option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
  </label>
  <label>S√©rie # :
    <input type="number" name="set_number" min="1" value="{{ session.set_logs.count|add:'1' }}">
  </label>
  <label>Reps :
    <input type="number" name="reps" min="1" required>
  </label>
  <label>Poids (kg) :
    <input type="number" name="weight_kg" step="0.5" min="0" required>
  </label>
  <button type="submit" class="btn" onclick="saveDuration()">Ajouter</button>
</form>
<script>
// Initialize custom select for session form
document.addEventListener('DOMContentLoaded', () => {
  const sessionSelect = document.querySelector('#addSetForm .custom-select');
  if (sessionSelect) {
    new CustomSelect(sessionSelect);
  }
});
</script>
{% endif %}

<h3>Logs</h3>
<table>
  <thead><tr><th>#</th><th>Exercice</th><th>Reps</th><th>Poids</th><th>Volume</th></tr></thead>
  <tbody>
    {% for s in session.set_logs.all %}
      <tr>
        <td>{{ s.set_number }}</td>
        <td>{{ s.exercise.name }}</td>
        <td>{{ s.reps }}</td>
        <td>{{ s.weight_kg }} kg</td>
        <td>{{ s.volume }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5">Aucune s√©rie pour le moment.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if not session.is_completed and session.set_logs.count > 0 %}
<div style="margin-top:2rem;text-align:center">
  <form method="post" action="{% url 'workouts:complete_session' session.pk %}" onsubmit="saveDuration()">
    {% csrf_token %}
    <input type="hidden" name="duration_minutes" id="complete_duration_minutes" value="0">
    <button type="submit" class="btn" style="background:#28a745;font-size:1.2rem;padding:12px 24px">
      üèÅ Terminer la s√©ance
    </button>
  </form>
</div>
{% endif %}

<style>
  #timer {
    color: #0b5ed7;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  }
  .card {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
</style>

{% if not session.is_completed %}
<script>
let seconds = 0;
let interval = null;
let isRunning = false;

const sessionKey = 'session_{{ session.pk }}_time';
const savedTime = localStorage.getItem(sessionKey);
if (savedTime) {
  seconds = parseInt(savedTime);
  updateDisplay();
}

function startTimer() {
  if (isRunning) return;
  isRunning = true;
  document.getElementById('pauseBtn').style.display = 'inline-block';
  document.getElementById('resumeBtn').style.display = 'none';
  interval = setInterval(() => {
    seconds++;
    updateDisplay();
    localStorage.setItem(sessionKey, seconds);
  }, 1000);
}

function pauseTimer() {
  isRunning = false;
  clearInterval(interval);
  document.getElementById('pauseBtn').style.display = 'none';
  document.getElementById('resumeBtn').style.display = 'inline-block';
}

function resumeTimer() {
  startTimer();
}

function resetTimer() {
  pauseTimer();
  seconds = 0;
  updateDisplay();
  localStorage.removeItem(sessionKey);
}

function updateDisplay() {
  const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
  const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
  const secs = (seconds % 60).toString().padStart(2, '0');
  document.getElementById('timer').textContent = `${hrs}:${mins}:${secs}`;
}

function saveDuration() {
  const durationMinutes = Math.floor(seconds / 60);
  const durationField = document.getElementById('duration_minutes');
  if (durationField) durationField.value = durationMinutes;
  const completeField = document.getElementById('complete_duration_minutes');
  if (completeField) completeField.value = durationMinutes;
}

window.addEventListener('load', () => {
  startTimer();
});
</script>
{% endif %}
{% endblock %}
