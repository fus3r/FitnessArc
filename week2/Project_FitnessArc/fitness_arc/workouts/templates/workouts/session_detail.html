{% extends "base.html" %}
{% block title %}S√©ance{% endblock %}
{% block content %}
<h1>S√©ance du {{ session.date }}</h1>

{% if session.is_completed %}
<div style="background:#d4edda;border:1px solid #c3e6cb;padding:1rem;border-radius:8px;margin-bottom:1rem">
  ‚úÖ <strong>S√©ance termin√©e !</strong> Dur√©e : {{ session.duration_minutes }} min | Calories : {{ session.estimated_calories_burned }} kcal
  <br><a href="{% url 'workouts:session_summary' session.pk %}" class="btn" style="margin-top:0.5rem">Voir le r√©capitulatif ‚Üí</a>
</div>
{% else %}
<div class="timer-card" style="text-align:center;margin-bottom:2rem">
  <div class="timer-display" id="timer">00:00:00</div>
  <div class="timer-controls">
    <button class="timer-btn timer-btn-pause" id="pauseBtn" onclick="pauseTimer()">
      <span class="timer-btn-icon">‚è∏</span>
      <span class="timer-btn-text">Pause</span>
    </button>
    <button class="timer-btn timer-btn-resume" id="resumeBtn" onclick="resumeTimer()" style="display:none">
      <span class="timer-btn-icon">‚ñ∂Ô∏è</span>
      <span class="timer-btn-text">Reprendre</span>
    </button>
    <button class="timer-btn timer-btn-reset" onclick="resetTimer()">
      <span class="timer-btn-icon">üîÑ</span>
      <span class="timer-btn-text">R√©initialiser</span>
    </button>
  </div>
</div>

<h3>Ajouter une s√©rie</h3>
<form method="post" style="margin-bottom:1rem" id="addSetForm">
  {% csrf_token %}
  <input type="hidden" name="duration_minutes" id="duration_minutes" value="0">
  <label>Exercice :
    <div class="custom-select">
      <select name="exercise_id" required>
        {% if session.from_template %}
          {% for item in session.from_template.items.all %}
            <option value="{{ item.exercise.id }}">{{ item.exercise.name }}</option>
          {% endfor %}
        {% endif %}
      </select>
    </div>
  </label>
  <label>S√©rie # :
    <input type="number" name="set_number" min="1" value="{{ session.set_logs.count|add:'1' }}">
  </label>
  <label>Reps :
    <input type="number" name="reps" min="1" required>
  </label>
  <label>Poids (kg) :
    <input type="number" name="weight_kg" step="0.5" min="0" required>
  </label>
  <button type="submit" class="btn" onclick="saveDuration()">Ajouter</button>
</form>
<script>
// Initialize custom select for session form
document.addEventListener('DOMContentLoaded', () => {
  const sessionSelect = document.querySelector('#addSetForm .custom-select');
  if (sessionSelect) {
    new CustomSelect(sessionSelect);
  }
});
</script>
{% endif %}

<h3>Logs</h3>
<table>
  <thead><tr><th>#</th><th>Exercice</th><th>Reps</th><th>Poids</th><th>Volume</th></tr></thead>
  <tbody>
    {% for s in session.set_logs.all %}
      <tr>
        <td>{{ s.set_number }}</td>
        <td>{{ s.exercise.name }}</td>
        <td>{{ s.reps }}</td>
        <td>{{ s.weight_kg }} kg</td>
        <td>{{ s.volume }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5">Aucune s√©rie pour le moment.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if not session.is_completed %}
<div class="finish-workout-container" id="finishContainer">
  <form method="post" action="{% url 'workouts:complete_session' session.pk %}" onsubmit="saveDuration()">
    {% csrf_token %}
    <input type="hidden" name="duration_minutes" id="complete_duration_minutes" value="0">
    <button type="submit" class="btn-finish-workout" id="finishBtn">
      <span class="finish-icon" id="finishIcon">üèÅ</span>
      <span class="finish-text" id="finishText">Terminer la s√©ance</span>
    </button>
  </form>
  <p class="finish-hint" id="finishHint">Vous pouvez terminer la s√©ance √† tout moment</p>
</div>
{% endif %}

<style>
  .timer-card {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 24px;
    padding: 2.5rem 2rem;
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.3),
      0 0 0 1px rgba(99, 102, 241, 0.1) inset,
      0 0 60px rgba(99, 102, 241, 0.15);
    position: relative;
    overflow: hidden;
  }
  
  .timer-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
    animation: pulse 3s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  
  .timer-display {
    font-size: 5rem;
    font-weight: 800;
    margin: 1rem 0 2rem 0;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 0.05em;
    font-variant-numeric: tabular-nums;
    text-shadow: 0 0 40px rgba(99, 102, 241, 0.5);
    filter: drop-shadow(0 4px 20px rgba(99, 102, 241, 0.4));
    position: relative;
    z-index: 1;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  .timer-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
    position: relative;
    z-index: 1;
  }
  
  .timer-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.75rem;
    border: none;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: 'Inter', sans-serif;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }
  
  .timer-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .timer-btn:hover::before {
    opacity: 1;
  }
  
  .timer-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }
  
  .timer-btn:active {
    transform: translateY(0);
  }
  
  .timer-btn-icon {
    font-size: 1.25rem;
    display: flex;
    align-items: center;
  }
  
  .timer-btn-pause {
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    color: #fff;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }
  
  .timer-btn-resume {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .timer-btn-reset {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: #fff;
    border: 1px solid rgba(107, 114, 128, 0.3);
  }
  
  .finish-workout-container {
    margin-top: 3rem;
    text-align: center;
    padding: 2rem;
    border-radius: 20px;
    position: relative;
    overflow: hidden;
    transition: all 0.5s ease;
  }
  
  .finish-workout-container.finish-mode {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .finish-workout-container.cancel-mode {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .finish-workout-container.finish-mode::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
  }
  
  .finish-workout-container.cancel-mode::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(239, 68, 68, 0.15) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
  }
  
  .btn-finish-workout {
    position: relative;
    z-index: 1;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 3rem;
    color: #fff;
    border: none;
    border-radius: 20px;
    font-size: 1.35rem;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .btn-finish-workout.btn-finish {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 
      0 8px 24px rgba(16, 185, 129, 0.4),
      0 0 0 1px rgba(16, 185, 129, 0.2) inset;
  }
  
  .btn-finish-workout.btn-cancel {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 
      0 8px 24px rgba(239, 68, 68, 0.4),
      0 0 0 1px rgba(239, 68, 68, 0.2) inset;
  }
  
  .btn-finish-workout::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 20px;
  }
  
  .btn-finish-workout.btn-finish:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 
      0 12px 36px rgba(16, 185, 129, 0.5),
      0 0 0 1px rgba(16, 185, 129, 0.3) inset;
  }
  
  .btn-finish-workout.btn-cancel:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 
      0 12px 36px rgba(239, 68, 68, 0.5),
      0 0 0 1px rgba(239, 68, 68, 0.3) inset;
  }
  
  .btn-finish-workout:hover::before {
    opacity: 1;
  }
  
  .btn-finish-workout:active {
    transform: translateY(-2px) scale(1);
  }
  
  .finish-icon {
    font-size: 1.75rem;
    display: flex;
    align-items: center;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  }
  
  .finish-text {
    letter-spacing: 0.02em;
  }
  
  .finish-hint {
    position: relative;
    z-index: 1;
    margin-top: 1rem;
    color: rgba(229, 231, 235, 0.7);
    font-size: 0.95rem;
    font-style: italic;
  }
  
  @media (max-width: 768px) {
    .timer-display {
      font-size: 3.5rem;
    }
    
    .timer-btn {
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
    }
    
    .btn-finish-workout {
      padding: 1rem 2rem;
      font-size: 1.15rem;
    }
    
    .finish-icon {
      font-size: 1.5rem;
    }
  }
</style>

{% if not session.is_completed %}
<script>
let seconds = 0;
let interval = null;
let isRunning = false;

const sessionKey = 'session_{{ session.pk }}_time';
const savedTime = localStorage.getItem(sessionKey);
if (savedTime) {
  seconds = parseInt(savedTime);
  updateDisplay();
}

function startTimer() {
  if (isRunning) return;
  isRunning = true;
  document.getElementById('pauseBtn').style.display = 'inline-block';
  document.getElementById('resumeBtn').style.display = 'none';
  interval = setInterval(() => {
    seconds++;
    updateDisplay();
    localStorage.setItem(sessionKey, seconds);
  }, 1000);
}

function pauseTimer() {
  isRunning = false;
  clearInterval(interval);
  document.getElementById('pauseBtn').style.display = 'none';
  document.getElementById('resumeBtn').style.display = 'inline-block';
}

function resumeTimer() {
  startTimer();
}

function resetTimer() {
  pauseTimer();
  seconds = 0;
  updateDisplay();
  localStorage.removeItem(sessionKey);
}

function updateDisplay() {
  const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
  const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
  const secs = (seconds % 60).toString().padStart(2, '0');
  document.getElementById('timer').textContent = `${hrs}:${mins}:${secs}`;
  
  // Mettre √† jour le bouton selon la dur√©e
  updateFinishButton();
}

function updateFinishButton() {
  const finishBtn = document.getElementById('finishBtn');
  const finishIcon = document.getElementById('finishIcon');
  const finishText = document.getElementById('finishText');
  const finishContainer = document.getElementById('finishContainer');
  const finishHint = document.getElementById('finishHint');
  
  if (!finishBtn) return;
  
  if (seconds < 30) {
    // Moins de 30 secondes : mode Annuler
    finishIcon.textContent = '‚ùå';
    finishText.textContent = 'Annuler le workout';
    finishBtn.classList.add('btn-cancel');
    finishBtn.classList.remove('btn-finish');
    finishContainer.classList.add('cancel-mode');
    finishContainer.classList.remove('finish-mode');
    finishHint.textContent = 'Le workout sera annul√© (< 30 secondes)';
  } else {
    // 30 secondes ou plus : mode Terminer
    finishIcon.textContent = 'üèÅ';
    finishText.textContent = 'Terminer la s√©ance';
    finishBtn.classList.add('btn-finish');
    finishBtn.classList.remove('btn-cancel');
    finishContainer.classList.add('finish-mode');
    finishContainer.classList.remove('cancel-mode');
    finishHint.textContent = 'Vous pouvez terminer la s√©ance √† tout moment';
  }
}

function saveDuration() {
  const durationMinutes = Math.floor(seconds / 60);
  const durationField = document.getElementById('duration_minutes');
  if (durationField) durationField.value = durationMinutes;
  const completeField = document.getElementById('complete_duration_minutes');
  if (completeField) completeField.value = durationMinutes;
}

window.addEventListener('load', () => {
  startTimer();
  updateFinishButton();
});
</script>
{% endif %}
{% endblock %}
