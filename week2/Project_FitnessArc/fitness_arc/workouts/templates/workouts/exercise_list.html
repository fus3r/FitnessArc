{% extends "base.html" %}
{% block title %}Exercices{% endblock %}
{% block content %}
<div id="exerciseApp">
  <h1>Bibliothèque d'exercices</h1>
  <p style="color:var(--text-dim);margin-bottom:2rem"><span v-text="exercises.length"></span> exercices disponibles</p>

  <div class="card" style="margin-bottom:2rem">
    <!-- Barre de recherche fancy -->
    <div style="position:relative;margin-bottom:1.5rem">
      <input 
        type="text" 
        v-model="searchQuery" 
        placeholder="Rechercher un exercice par nom..."
        style="padding:1rem 1rem 1rem 3rem;font-size:1rem;border:2px solid rgba(99,102,241,0.3);border-radius:12px;background:rgba(18,18,26,0.8);transition:all 0.3s"
        @focus="searchFocused = true"
        @blur="searchFocused = false">
      <svg 
        width="20" height="20" 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        stroke-width="2"
        style="position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--primary);opacity:0.7">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <div 
        v-if="searchQuery" 
        @click="searchQuery = ''" 
        style="position:absolute;right:1rem;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--text-dim);font-size:1.25rem;font-weight:bold;transition:color 0.2s"
        @mouseover="clearHover = true"
        @mouseleave="clearHover = false"
        :style="{color: clearHover ? 'var(--danger)' : 'var(--text-dim)'}">
        ×
      </div>
      <div 
        v-if="searchQuery && filteredExercises.length > 0" 
        style="margin-top:0.5rem;font-size:0.9rem;color:var(--primary)">
        ✓ <span v-text="filteredExercises.length"></span> résultat(s) trouvé(s)
      </div>
    </div>

    <!-- Filtres Sports (Checkboxes) -->
    <div style="margin-bottom:1.5rem">
      <label style="display:block;margin-bottom:0.75rem;font-weight:600;color:var(--primary)">
        Sports
      </label>
      <div style="display:flex;flex-wrap:wrap;gap:0.75rem">
        <label 
          v-for="cat in sportCategories" 
          :key="cat.id"
          style="display:flex;align-items:center;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;transition:all 0.2s;border:2px solid rgba(99,102,241,0.3);background:rgba(18,18,26,0.6)"
          :style="{
            borderColor: filters.sportCategories.includes(cat.id) ? 'var(--primary)' : 'rgba(99,102,241,0.3)',
            background: filters.sportCategories.includes(cat.id) ? 'rgba(99,102,241,0.2)' : 'rgba(18,18,26,0.6)'
          }">
          <input 
            type="checkbox" 
            :value="cat.id" 
            v-model="filters.sportCategories"
            @change="applyFilters"
            style="margin-right:0.5rem">
          <span :style="{fontSize: '1.25rem', marginRight: '0.5rem'}" v-text="cat.icon"></span>
          <span v-text="cat.name"></span>
        </label>
      </div>
    </div>

    <!-- Filtres avec custom dropdowns -->
    <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:1rem;align-items:end">
      <label>
        Groupe musculaire
        <div class="custom-select" ref="muscleDropdown">
          <select v-model="filters.muscle" @change="applyFilters">
            <option value="">Tous</option>
            <option value="chest">Pectoraux</option>
            <option value="back">Dos</option>
            <option value="legs">Jambes</option>
            <option value="shoulders">Épaules</option>
            <option value="arms">Bras</option>
            <option value="core">Abdos</option>
            <option value="cardio">Cardio</option>
            <option value="technique">Technique</option>
          </select>
        </div>
      </label>
      <label>
        Équipement
        <div class="custom-select" ref="equipmentDropdown">
          <select v-model="filters.equipment" @change="applyFilters">
            <option value="">Tous</option>
            <option value="barbell">Barre</option>
            <option value="dumbbell">Haltères</option>
            <option value="machine">Machine</option>
            <option value="cable">Poulie</option>
            <option value="bodyweight">Poids du corps</option>
            <option value="ball">Ballon</option>
            <option value="racket">Raquette</option>
            <option value="water">Eau</option>
            <option value="none">Aucun</option>
          </select>
        </div>
      </label>
      <button @click="resetFilters" class="btn btn-secondary">Réinitialiser</button>
    </div>
  </div>

  <!-- Grille d'exercices avec v-for Vue.js -->
  <div v-if="filteredExercises.length > 0" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem">
    <div v-for="(ex, index) in filteredExercises" :key="ex.id" 
         class="item-card" 
         :style="{animationDelay: (index * 0.05) + 's'}"
         style="cursor:pointer;padding:1.5rem">
      <div v-if="ex.image" style="width:100%;height:180px;border-radius:12px;overflow:hidden;margin-bottom:1rem;background:rgba(99,102,241,0.1)">
        <img :src="'/media/' + ex.image" :alt="ex.name" 
             style="width:100%;height:100%;object-fit:cover"
             @error="handleImageError">
      </div>
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.75rem">
        <h3 style="margin:0;font-size:1.25rem">
          <span v-if="ex.sport_category" :style="{marginRight: '0.5rem', fontSize: '1.1rem'}" v-text="ex.sport_category.icon"></span>
          <span v-text="ex.name"></span>
        </h3>
        <span class="badge badge-primary" v-text="getMuscleLabel(ex.muscle_group)"></span>
      </div>
      <div style="display:flex;gap:1rem;font-size:0.9rem;color:var(--text-dim)">
        <div>
          <span style="opacity:0.7">Équipement:</span>
          <strong style="margin-left:0.25rem" v-text="getEquipmentLabel(ex.equipment)"></strong>
        </div>
        <div>
          <span style="opacity:0.7">Difficulté:</span>
          <strong style="margin-left:0.25rem;color:var(--warning)" v-html="'★'.repeat(ex.difficulty)"></strong>
        </div>
      </div>
    </div>
  </div>

  <!-- Message si aucun résultat -->
  <div v-else class="card" style="text-align:center;padding:3rem;margin-top:2rem">
    <p style="color:var(--text-dim)">
      <span v-if="searchQuery">Aucun exercice trouvé pour "<span v-text="searchQuery"></span>"</span>
      <span v-else-if="filters.muscle || filters.equipment">Aucun exercice trouvé avec ces filtres</span>
      <span v-else>Chargement des exercices...</span>
    </p>
    <button @click="resetFilters" class="btn" style="margin-top:1rem" v-if="searchQuery || filters.muscle || filters.equipment">
      Réinitialiser les filtres
    </button>
    
    <!-- Debug info -->
    <div style="margin-top:2rem;padding:1rem;background:rgba(239,68,68,0.1);border-radius:8px;font-size:0.9rem">
      <p><strong>Debug:</strong></p>
      <p>Total exercices: <span v-text="exercises.length"></span></p>
      <p>Recherche: "<span v-text="searchQuery || 'vide'"></span>"</p>
      <p>Filtre muscle: <span v-text="filters.muscle || 'aucun'"></span></p>
      <p>Filtre équipement: <span v-text="filters.equipment || 'aucun'"></span></p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      exercises: {{ exercises_json|safe }},
      sportCategories: [
        {% for cat in sport_categories %}
        { id: {{ cat.id }}, name: "{{ cat.name }}", icon: "{{ cat.icon }}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      searchQuery: '',
      searchFocused: false,
      clearHover: false,
      filters: {
        muscle: '{{ request.GET.muscle|default:"" }}',
        equipment: '{{ request.GET.equip|default:"" }}',
        sportCategories: {{ selected_sport_cats|safe }}
      }
    }
  },
  computed: {
    filteredExercises() {
      let filtered = this.exercises;
      
      // Filtre par recherche texte
      if (this.searchQuery.trim()) {
        const query = this.searchQuery.toLowerCase().trim();
        filtered = filtered.filter(ex => 
          ex.name.toLowerCase().includes(query) ||
          ex.description.toLowerCase().includes(query)
        );
      }
      
      // Filtre par catégorie de sport
      if (this.filters.sportCategories.length > 0) {
        filtered = filtered.filter(ex => 
          ex.sport_category && this.filters.sportCategories.includes(ex.sport_category.id)
        );
      }
      
      // Filtre par muscle
      if (this.filters.muscle) {
        filtered = filtered.filter(ex => ex.muscle_group === this.filters.muscle);
      }
      
      // Filtre par équipement
      if (this.filters.equipment) {
        filtered = filtered.filter(ex => ex.equipment === this.filters.equipment);
      }
      
      return filtered;
    }
  },
  methods: {
    applyFilters() {
      const params = new URLSearchParams();
      if (this.filters.muscle) params.set('muscle', this.filters.muscle);
      if (this.filters.equipment) params.set('equip', this.filters.equipment);
      this.filters.sportCategories.forEach(catId => params.append('sport_category', catId));
      window.history.replaceState({}, '', `?${params.toString()}`);
    },
    resetFilters() {
      this.searchQuery = '';
      this.filters = {muscle: '', equipment: '', sportCategories: []};
      window.history.replaceState({}, '', window.location.pathname);
    },
    getMuscleLabel(muscle) {
      const labels = {
        chest: 'Pecs', back: 'Dos', legs: 'Jambes', shoulders: 'Épaules', 
        arms: 'Bras', core: 'Abdos', cardio: 'Cardio', technique: 'Technique'
      };
      return labels[muscle] || muscle;
    },
    getEquipmentLabel(equip) {
      const labels = {
        barbell: 'Barre', dumbbell: 'Haltères', machine: 'Machine', 
        cable: 'Poulie', bodyweight: 'Poids du corps', ball: 'Ballon',
        racket: 'Raquette', water: 'Eau', none: 'Aucun'
      };
      return labels[equip] || equip;
    },
    handleImageError(e) {
      e.target.style.display = 'none';
    }
  },
  mounted() {
    console.log('Vue app mounted, initializing custom selects...');
    console.log('CustomSelect class available:', typeof CustomSelect);
    
    // Initialize custom selects after Vue renders
    this.$nextTick(() => {
      // Wait a bit more to ensure DOM is fully ready
      setTimeout(() => {
        console.log('Refs:', this.$refs);
        
        // Try with refs first
        if (this.$refs.muscleDropdown) {
          console.log('Muscle dropdown ref found:', this.$refs.muscleDropdown);
          try {
            new CustomSelect(this.$refs.muscleDropdown);
            console.log('✓ Muscle dropdown initialized');
          } catch (error) {
            console.error('✗ Failed to init muscle dropdown:', error);
          }
        }
        
        if (this.$refs.equipmentDropdown) {
          console.log('Equipment dropdown ref found:', this.$refs.equipmentDropdown);
          try {
            new CustomSelect(this.$refs.equipmentDropdown);
            console.log('✓ Equipment dropdown initialized');
          } catch (error) {
            console.error('✗ Failed to init equipment dropdown:', error);
          }
        }
        
        // Fallback: find all custom selects
        const customSelects = this.$el.querySelectorAll('.custom-select');
        console.log(`Found ${customSelects.length} custom select(s) in Vue app`);
        
        customSelects.forEach((element, index) => {
          if (!element.hasAttribute('data-custom-select-status')) {
            try {
              console.log(`Initializing dropdown ${index + 1}...`);
              new CustomSelect(element);
              console.log(`✓ Dropdown ${index + 1} initialized`);
            } catch (error) {
              console.error(`✗ Failed to init dropdown ${index + 1}:`, error);
            }
          }
        });
      }, 300);
    });
  }
}).mount('#exerciseApp');
</script>

<style>
/* Animation focus barre de recherche */
input[type="text"]:focus {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 4px rgba(99,102,241,0.2) !important;
  transform: translateY(-2px);
}

/* Animation des résultats */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.item-card {
  animation: fadeInUp 0.3s ease;
}
</style>
{% endblock %}