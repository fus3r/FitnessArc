{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1>Tableau de bord</h1>
<p style="color:var(--text-dim);margin-bottom:2rem">Vue d'ensemble de votre activit√© du {{ today|date:"l d M" }}</p>

<style>
  .card {
    border-radius: 12px;
    padding: 1.25rem;
    background: #0b0d10;
    border: 1px solid #1f2937;
    height: auto;                 
  }

  /* Affichage graphe */
  .chart-card {
    display: flex;
    flex-direction: column;
  }

  .chart-container {
    position: relative;
    height: 220px;               
    margin-top: 0.75rem;
  }

  .chart-container canvas {
    position: absolute;
    inset: 0;                    
  }

  /* Affichage horloge digitale */

 
  .stat-card-circle {
   
    background: transparent;
    border: none;
    box-shadow: none;

    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0;                         
  }

  .round-clock {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    border: 3px solid rgba(59,130,246,0.8);           
    background: radial-gradient(circle at 30% 20%,
                rgba(59,130,246,0.3),
                rgba(15,23,42,1));                     
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .round-clock-time {
    font-size: 1.7rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco,
                 Consolas, "Liberation Mono", "Courier New", monospace;
    color: #e5e7eb;                                    
  }

  .round-clock-caption {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-align: center;
  }

  /* calendrier */
  .calendar-grid {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .calendar-week-header,
  .calendar-week {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.25rem;
  }

  .calendar-week-header span {
    font-size: 0.7rem;
    text-align: center;
    color: #9ca3af;
  }

  .calendar-day {
    border-radius: 8px;
    padding: 0.35rem 0;
    font-size: 0.85rem;
    border: 1px solid transparent;
    background: transparent;
    color: #6b7280;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.15rem;
    transition: background 0.15s, border-color 0.15s, transform 0.1s;
  }

  .calendar-day-out {
    opacity: 0.25;                 
  }

  .calendar-day-has {
    color: #e5e7eb;
    border-color: rgba(59,130,246,0.5);
    background: radial-gradient(circle at 30% 20%,
                rgba(59,130,246,0.25),
                rgba(15,23,42,1));
  }

  .calendar-day-today {
    box-shadow: 0 0 0 1px rgba(236,72,153,0.7);
  }

  .calendar-day-selected {
  box-shadow: 0 0 0 2px #a855f7;
  border-color: #a855f7;
  background: radial-gradient(circle at 30% 20%,
              rgba(168,85,247,0.35),
              rgba(15,23,42,1));
  color: #f10707;
  transform: translateY(-1px);
}

  .calendar-day-number {
    line-height: 1;
  }

  .calendar-day-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: #22c55e;           
  }
</style>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem">
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Calories Consomm√©es</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--text)">{{ calories_consumed }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">Prot√©ines : {{ protein_consumed }}g</p>
  </div>
  
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.15));border:1px solid rgba(239,68,68,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Calories Br√ªl√©es</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--danger)">{{ calories_burned }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">S√©ances : {{ sessions_count }}</p>
  </div>
  
  {% if calorie_balance > 0 %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.15));border:1px solid rgba(16,185,129,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--success)">+{{ calorie_balance|floatformat:0 }}</p>
  {% elif calorie_balance < 0 %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));border:1px solid rgba(245,158,11,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--warning)">{{ calorie_balance|floatformat:0 }}</p>
  {% else %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--text)">{{ calorie_balance|floatformat:0 }}</p>
  {% endif %}
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">
      {% if calorie_balance > 0 %}Surplus{% elif calorie_balance < 0 %}D√©ficit{% else %}√âquilibre{% endif %}
    </p>
  </div>
  
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.15));border:1px solid rgba(236,72,153,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Volume (7 jours)</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--accent)">{{ weekly_volume|floatformat:0 }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">kg √ó reps</p>
  </div>
</div>

  

<!-- Graphiques Analytics -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem">
  <!-- ... tes autres stat-cards (calories, balance, volume, etc.) ... -->

  <div class="stat-card stat-card-circle">
    <div class="round-clock">
      <span class="round-clock-time">
        {{ weekly_training_hours|stringformat:"02d" }}:{{ weekly_training_min|stringformat:"02d" }}
      </span>
    </div>

    <div class="round-clock-caption">
      Temps d'entra√Ænement (7 derniers jours)
    </div>
  </div>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem">   
  <div class="card">
    <h3>Workouts par Semaine (5 derni√®res)</h3>
    <div class="chart-container">
      <canvas id="weeklyWorkoutsChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <h3>Calories Journali√®res (7 derniers jours)</h3>
    <div class="chart-container">
      <canvas id="dailyCaloriesChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <h3>Volume d'Entra√Ænement (5 derni√®res semaines)</h3>
    <div class="chart-container">
      <canvas id="weeklyVolumeChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <h3>R√©partition Macros (Aujourd'hui)</h3>
    <div class="chart-container">
      <canvas id="macrosChart"></canvas>
    </div>
  </div>
</div>

{% if calendar_weeks %}
<div class="card" style="margin-bottom:1.5rem">
  <h3 style="margin:0 0 0.5rem;">Calendrier des Workouts (mois en cours)</h3>

  <!-- Grille du calendrier -->
  <div class="calendar-grid">
    <!-- En-t√™te des jours -->
    <div class="calendar-week-header">
      <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
    </div>

    {% for week in calendar_weeks %}
      <div class="calendar-week">
        {% for day in week %}
          <button
            type="button"
            class="calendar-day
                   {% if not day.in_month %} calendar-day-out{% endif %}
                   {% if day.has_workout %} calendar-day-has{% endif %}
                   {% if day.is_today %} calendar-day-today{% endif %}"
            data-date="{{ day.date|date:'Y-m-d' }}"
          >
            <span class="calendar-day-number">{{ day.day }}</span>
            {% if day.has_workout %}
              <span class="calendar-day-dot"></span>
            {% endif %}
          </button>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- Zone d'affichage des s√©ances du jour s√©lectionn√© -->
  <div id="calendar-details-container" style="margin-top:1rem;">
    <p style="color:#9ca3af;font-size:0.9rem;margin:0 0 0.5rem">
      Cliquez sur un jour avec un point pour voir les s√©ances.
    </p>

    <!-- Message quand aucun workout ce jour-l√† -->
    <div id="calendar-empty-message"
         style="display:none;color:#9ca3af;font-size:0.9rem;margin-bottom:0.75rem;">
    </div>

    <!-- Panneaux de d√©tails (un par jour avec au moins une s√©ance) -->
    {% for week in calendar_weeks %}
      {% for day in week %}
        {% if day.sessions %}
          <div class="calendar-details-panel"
               id="details-{{ day.date|date:'Y-m-d' }}"
               style="display:none;">

            <!-- Titre du jour -->
            <div style="font-size:0.9rem;color:#e5e7eb;margin-bottom:0.5rem;">
              S√©ances du {{ day.date|date:"l d M Y" }}
            </div>

            {% for session in day.sessions %}
              <div style="
                  border:1px solid #1f2937;
                  border-radius:10px;
                  padding:0.75rem 0.9rem;
                  margin-bottom:0.75rem;
                  background:#020617;
                ">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">
                  <div>
                    <strong>
                      {% if session.from_template %}
                        {{ session.from_template.name }}
                      {% else %}
                        S√©ance du {{ session.date|date:"d/m/Y" }}
                      {% endif %}
                    </strong>
                    <div style="font-size:0.8rem;color:#9ca3af;">
                      {{ session.date|date:"l d M" }} ‚Ä¢ {{ session.duration_minutes }} min
                    </div>
                  </div>
                  <div style="font-size:0.8rem;color:#f97316;">
                    üî• {{ session.estimated_calories_burned }} kcal
                  </div>
                </div>

                <div style="
                    margin-top:0.5rem;
                    display:flex;
                    justify-content:space-between;
                    align-items:center;
                    font-size:0.85rem;
                    color:#9ca3af;
                  ">
                  <div>
                    Volume total :
                    <strong>{{ session.total_volume|floatformat:0 }} kg</strong>
                  </div>
                  <a href="{% url 'workouts:session_summary' session.pk %}"
                     class="btn"
                     style="padding:4px 12px;font-size:0.8rem;">
                    Voir d√©tails ‚Üí
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
</div>
{% endif %}

<!--
{% if workout_history %}
<div class="card" style="margin-bottom:1.5rem">
  <h3>Historique des Workouts (30 derniers jours)</h3>
  {% for item in workout_history %}
  <div style="border:1px solid #e5e7eb;border-radius:8px;padding:1rem;margin:1rem 0;background:#f9fafb">
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem">
      <div>
        <h4 style="margin:0;color:#111">
          {% if item.session.from_template %}
            {{ item.session.from_template.name }}
          {% else %}
            S√©ance du {{ item.session.date|date:"d/m/Y" }}
          {% endif %}
        </h4>
        <p style="color:#666;font-size:0.9rem;margin:0.25rem 0">
          {{ item.session.date|date:"l d M Y" }} ‚Ä¢ {{ item.session.duration_minutes }} min
        </p>
      </div>
      <div style="text-align:right">
        <span style="background:#667eea;color:#fff;padding:4px 8px;border-radius:6px;font-size:0.85rem">
          üî• {{ item.session.estimated_calories_burned }} kcal
        </span>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.5rem;margin:0.75rem 0">
      {% for ex_name, data in item.exercises.items %}
      <div style="background:#fff;padding:0.5rem;border-radius:6px;font-size:0.85rem">
        <strong>{{ ex_name }}</strong><br>
        <span style="color:#666">{{ data.sets }} s√©ries ‚Ä¢ {{ data.reps }} reps</span>
      </div>
      {% endfor %}
    </div>
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid #e5e7eb">
      <div style="font-size:0.9rem;color:#666">
        üìä Volume total: <strong>{{ item.session.total_volume|floatformat:0 }} kg</strong> ‚Ä¢ 
        S√©ries: <strong>{{ item.total_sets }}</strong>
        {% if item.prs_count > 0 %}
        ‚Ä¢ üèÜ <strong style="color:#f59e0b">{{ item.prs_count }} nouveau(x) PR(s)</strong>
        {% endif %}
      </div>
      <a href="{% url 'workouts:session_summary' item.session.pk %}" class="btn" style="padding:4px 12px;font-size:0.85rem">
        Voir d√©tails ‚Üí
      </a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}
-->

{% if recent_prs %}
<div class="card" style="margin-top:1.5rem">
  <h3>üèÜ Records R√©cents (PRs)</h3>
  <table>
    <thead><tr><th>Date</th><th>Exercice</th><th>Type</th><th>Valeur</th></tr></thead>
    <tbody>
      {% for pr in recent_prs %}
      <tr>
        <td>{{ pr.date|date:"d/m/Y" }}</td>
        <td>{{ pr.exercise.name }}</td>
        <td>{{ pr.get_metric_display }}</td>
        <td><strong>{{ pr.value }} kg</strong></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const days = document.querySelectorAll('.calendar-day');
  const panels = document.querySelectorAll('.calendar-details-panel');
  const emptyMsg = document.getElementById('calendar-empty-message');

  // Cache tous les panneaux de d√©tails
  function hideAllPanels() {
    panels.forEach(p => p.style.display = 'none');
  }

  // Enl√®ve le highlight de tous les jours
  function clearSelectedDays() {
    days.forEach(d => d.classList.remove('calendar-day-selected'));
  }

  days.forEach(btn => {
    btn.addEventListener('click', () => {
      const date = btn.dataset.date;   // ex: "2025-11-13"

      clearSelectedDays();
      btn.classList.add('calendar-day-selected');

      hideAllPanels();

      const panel = document.getElementById('details-' + date);

      if (panel) {
        // Il y a des s√©ances ce jour-l√†
        if (emptyMsg) {
          emptyMsg.style.display = 'none';
          emptyMsg.textContent = '';
        }
        panel.style.display = 'block';
      } else {
        // Aucune s√©ance ce jour-l√†
        if (emptyMsg) {
          emptyMsg.textContent = "Pas de s√©ance ce jour-l√†.";
          emptyMsg.style.display = 'block';
        }
      }
    });
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configuration globale Chart.js
Chart.defaults.color = '#9ca3af';
Chart.defaults.borderColor = 'rgba(99,102,241,0.1)';
Chart.defaults.font.family = "'Inter', sans-serif";

// 1. Workouts par Semaine
const weeklyWorkoutsCtx = document.getElementById('weeklyWorkoutsChart');
if (weeklyWorkoutsCtx) {  // s√©curit√© : on v√©rifie que le canvas existe
  new Chart(weeklyWorkoutsCtx, {
    type: 'bar',
    data: {
      labels: {{ weekly_workouts_labels|safe }},
      datasets: [{
        label: 'Workouts',
        data: {{ weekly_workouts_data|safe }},
        backgroundColor: 'rgba(99,102,241,0.6)',
        borderColor: 'rgba(99,102,241,0.8)',
        borderWidth: 2,
        borderRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(99,102,241,0.3)',
          borderWidth: 1,
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          grid: { color: 'rgba(99,102,241,0.1)' }
        },
        x: { grid: { display: false } }
      }
    }
  });
}

// 2. Calories Journali√®res
const dailyCaloriesCtx = document.getElementById('dailyCaloriesChart');
if (dailyCaloriesCtx) {
  console.log("daily labels =", {{ daily_calories_labels|safe }});
  console.log("daily consumed =", {{ daily_calories_consumed|safe }});
  console.log("daily burned =", {{ daily_calories_burned|safe }});

  new Chart(dailyCaloriesCtx, {
    type: 'line',
    data: {
      labels: {{ daily_calories_labels|safe }},
      datasets: [{
        label: 'Consomm√©es',
        data: {{ daily_calories_consumed|safe }},
        borderColor: 'rgba(99,102,241,0.8)',
        backgroundColor: 'rgba(99,102,241,0.2)',
        fill: true,
        tension: 0.4,
      }, {
        label: 'Br√ªl√©es',
        data: {{ daily_calories_burned|safe }},
        borderColor: 'rgba(239,68,68,0.8)',
        backgroundColor: 'rgba(239,68,68,0.2)',
        fill: true,
        tension: 0.4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(99,102,241,0.3)',
          borderWidth: 1,
        }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' } },
        x: { grid: { display: false } }
      }
    }
  });
}

// 3. Volume Hebdomadaire
const weeklyVolumeCtx = document.getElementById('weeklyVolumeChart');
if (weeklyVolumeCtx) {
  console.log("weekly volume labels =", {{ weekly_volume_labels|safe }});
  console.log("weekly volume data =", {{ weekly_volume_data|safe }});

  new Chart(weeklyVolumeCtx, {
    type: 'line',
    data: {
      labels: {{ weekly_volume_labels|safe }},
      datasets: [{
        label: 'Volume (kg)',
        data: {{ weekly_volume_data|safe }},
        borderColor: 'rgba(236,72,153,0.8)',
        backgroundColor: 'rgba(236,72,153,0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(236,72,153,0.3)',
          borderWidth: 1,
        }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' } },
        x: { grid: { display: false } }
      }
    }
  });
}

// 4. R√©partition Macros
const macrosCtx = document.getElementById('macrosChart');
if (macrosCtx) {
  console.log("macros =", {{ protein_consumed|default:0 }}, {{ carbs_consumed|default:0 }}, {{ fat_consumed|default:0 }});

  new Chart(macrosCtx, {
    type: 'doughnut',
    data: {
      labels: ['Prot√©ines', 'Glucides', 'Lipides'],
      datasets: [{
        data: [{{ protein_consumed|default:0 }}, {{ carbs_consumed|default:0 }}, {{ fat_consumed|default:0 }}],
        backgroundColor: [
          'rgba(16,185,129,0.6)',
          'rgba(245,158,11,0.6)',
          'rgba(236,72,153,0.6)'
        ],
        borderColor: [
          'rgba(16,185,129,0.8)',
          'rgba(245,158,11,0.8)',
          'rgba(236,72,153,0.8)'
        ],
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(99,102,241,0.3)',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + 'g';
            }
          }
        }
      }
    }
  });
}
</script>
{% endblock %}
