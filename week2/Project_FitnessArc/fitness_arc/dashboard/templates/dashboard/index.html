{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1>Tableau de bord</h1>
<p style="color:var(--text-dim);margin-bottom:2rem">Vue d'ensemble de votre activit√© du {{ today|date:"l d M" }}</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem">
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Calories Consomm√©es</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--text)">{{ calories_consumed }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">Prot√©ines : {{ protein_consumed }}g</p>
  </div>
  
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.15));border:1px solid rgba(239,68,68,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Calories Br√ªl√©es</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--danger)">{{ calories_burned }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">S√©ances : {{ sessions_count }}</p>
  </div>
  
  {% if calorie_balance > 0 %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.15));border:1px solid rgba(16,185,129,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--success)">+{{ calorie_balance|floatformat:0 }}</p>
  {% elif calorie_balance < 0 %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));border:1px solid rgba(245,158,11,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--warning)">{{ calorie_balance|floatformat:0 }}</p>
  {% else %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--text)">{{ calorie_balance|floatformat:0 }}</p>
  {% endif %}
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">
      {% if calorie_balance > 0 %}Surplus{% elif calorie_balance < 0 %}D√©ficit{% else %}√âquilibre{% endif %}
    </p>
  </div>
  
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.15));border:1px solid rgba(236,72,153,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Volume (7 jours)</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--accent)">{{ weekly_volume|floatformat:0 }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">kg √ó reps</p>
  </div>
</div>

<!-- Graphiques Analytics -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem">
  <div class="card">
    <h3>Workouts par Semaine (5 derni√®res)</h3>
    <canvas id="weeklyWorkoutsChart" height="200"></canvas>
  </div>
  
  <div class="card">
    <h3>Calories Journali√®res (7 derniers jours)</h3>
    <canvas id="dailyCaloriesChart" height="200"></canvas>
  </div>
  
  <div class="card">
    <h3>Volume d'Entra√Ænement (5 derni√®res semaines)</h3>
    <canvas id="weeklyVolumeChart" height="200"></canvas>
  </div>
  
  <div class="card">
    <h3>R√©partition Macros (Aujourd'hui)</h3>
    <canvas id="macrosChart" height="200"></canvas>
  </div>
</div>

{% if workout_history %}
<div class="card" style="margin-bottom:1.5rem">
  <h3>Historique des Workouts (30 derniers jours)</h3>
  {% for item in workout_history %}
  <div style="border:1px solid #e5e7eb;border-radius:8px;padding:1rem;margin:1rem 0;background:#f9fafb">
    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem">
      <div>
        <h4 style="margin:0;color:#111">
          {% if item.session.from_template %}
            {{ item.session.from_template.name }}
          {% else %}
            S√©ance du {{ item.session.date|date:"d/m/Y" }}
          {% endif %}
        </h4>
        <p style="color:#666;font-size:0.9rem;margin:0.25rem 0">
          {{ item.session.date|date:"l d M Y" }} ‚Ä¢ {{ item.session.duration_minutes }} min
        </p>
      </div>
      <div style="text-align:right">
        <span style="background:#667eea;color:#fff;padding:4px 8px;border-radius:6px;font-size:0.85rem">
          üî• {{ item.session.estimated_calories_burned }} kcal
        </span>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.5rem;margin:0.75rem 0">
      {% for ex_name, data in item.exercises.items %}
      <div style="background:#fff;padding:0.5rem;border-radius:6px;font-size:0.85rem">
        <strong>{{ ex_name }}</strong><br>
        <span style="color:#666">{{ data.sets }} s√©ries ‚Ä¢ {{ data.reps }} reps</span>
      </div>
      {% endfor %}
    </div>
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid #e5e7eb">
      <div style="font-size:0.9rem;color:#666">
        üìä Volume total: <strong>{{ item.session.total_volume|floatformat:0 }} kg</strong> ‚Ä¢ 
        S√©ries: <strong>{{ item.total_sets }}</strong>
        {% if item.prs_count > 0 %}
        ‚Ä¢ üèÜ <strong style="color:#f59e0b">{{ item.prs_count }} nouveau(x) PR(s)</strong>
        {% endif %}
      </div>
      <a href="{% url 'workouts:session_summary' item.session.pk %}" class="btn" style="padding:4px 12px;font-size:0.85rem">
        Voir d√©tails ‚Üí
      </a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if recent_prs %}
<div class="card" style="margin-top:1.5rem">
  <h3>üèÜ Records R√©cents (PRs)</h3>
  <table>
    <thead><tr><th>Date</th><th>Exercice</th><th>Type</th><th>Valeur</th></tr></thead>
    <tbody>
      {% for pr in recent_prs %}
      <tr>
        <td>{{ pr.date|date:"d/m/Y" }}</td>
        <td>{{ pr.exercise.name }}</td>
        <td>{{ pr.get_metric_display }}</td>
        <td><strong>{{ pr.value }} kg</strong></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configuration globale Chart.js
Chart.defaults.color = '#9ca3af';
Chart.defaults.borderColor = 'rgba(99,102,241,0.1)';
Chart.defaults.font.family = "'Inter', sans-serif";

// 1. Workouts par Semaine
const weeklyWorkoutsCtx = document.getElementById('weeklyWorkoutsChart');
new Chart(weeklyWorkoutsCtx, {
  type: 'bar',
  data: {
    labels: {{ weekly_workouts_labels|safe }},
    datasets: [{
      label: 'Workouts',
      data: {{ weekly_workouts_data|safe }},
      backgroundColor: 'rgba(99,102,241,0.6)',
      borderColor: 'rgba(99,102,241,0.8)',
      borderWidth: 2,
      borderRadius: 8,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(26,26,36,0.95)',
        padding: 12,
        borderColor: 'rgba(99,102,241,0.3)',
        borderWidth: 1,
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: { stepSize: 1 },
        grid: { color: 'rgba(99,102,241,0.1)' }
      },
      x: { grid: { display: false } }
    }
  }
});

// 2. Calories Journali√®res
const dailyCaloriesCtx = document.getElementById('dailyCaloriesChart');
new Chart(dailyCaloriesCtx, {
  type: 'line',
  data: {
    labels: {{ daily_calories_labels|safe }},
    datasets: [{
      label: 'Consomm√©es',
      data: {{ daily_calories_consumed|safe }},
      borderColor: 'rgba(99,102,241,0.8)',
      backgroundColor: 'rgba(99,102,241,0.2)',
      fill: true,
      tension: 0.4,
    }, {
      label: 'Br√ªl√©es',
      data: {{ daily_calories_burned|safe }},
      borderColor: 'rgba(239,68,68,0.8)',
      backgroundColor: 'rgba(239,68,68,0.2)',
      fill: true,
      tension: 0.4,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'top', labels: { usePointStyle: true } },
      tooltip: {
        backgroundColor: 'rgba(26,26,36,0.95)',
        padding: 12,
        borderColor: 'rgba(99,102,241,0.3)',
        borderWidth: 1,
      }
    },
    scales: {
      y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' } },
      x: { grid: { display: false } }
    }
  }
});

// 3. Volume Hebdomadaire
const weeklyVolumeCtx = document.getElementById('weeklyVolumeChart');
new Chart(weeklyVolumeCtx, {
  type: 'line',
  data: {
    labels: {{ weekly_volume_labels|safe }},
    datasets: [{
      label: 'Volume (kg)',
      data: {{ weekly_volume_data|safe }},
      borderColor: 'rgba(236,72,153,0.8)',
      backgroundColor: 'rgba(236,72,153,0.2)',
      fill: true,
      tension: 0.4,
      pointRadius: 6,
      pointHoverRadius: 8,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(26,26,36,0.95)',
        padding: 12,
        borderColor: 'rgba(236,72,153,0.3)',
        borderWidth: 1,
      }
    },
    scales: {
      y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' } },
      x: { grid: { display: false } }
    }
  }
});

// 4. R√©partition Macros
const macrosCtx = document.getElementById('macrosChart');
new Chart(macrosCtx, {
  type: 'doughnut',
  data: {
    labels: ['Prot√©ines', 'Glucides', 'Lipides'],
    datasets: [{
      data: [{{ protein_consumed }}, {{ carbs_consumed }}, {{ fat_consumed }}],
      backgroundColor: [
        'rgba(16,185,129,0.6)',
        'rgba(245,158,11,0.6)',
        'rgba(236,72,153,0.6)'
      ],
      borderColor: [
        'rgba(16,185,129,0.8)',
        'rgba(245,158,11,0.8)',
        'rgba(236,72,153,0.8)'
      ],
      borderWidth: 2,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } },
      tooltip: {
        backgroundColor: 'rgba(26,26,36,0.95)',
        padding: 12,
        borderColor: 'rgba(99,102,241,0.3)',
        borderWidth: 1,
        callbacks: {
          label: function(context) {
            return context.label + ': ' + context.parsed + 'g';
          }
        }
      }
    }
  }
});
</script>
{% endblock %}
