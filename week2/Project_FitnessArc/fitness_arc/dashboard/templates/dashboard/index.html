{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1>Tableau de bord</h1>
<p style="color:var(--text-dim);margin-bottom:2rem">Vue d'ensemble de votre activit√© du {{ today|date:"l d M" }}</p>

<style>
  .card {
    border-radius: 12px;
    padding: 1.25rem;
    background: #0b0d10;
    border: 1px solid #1f2937;
    height: auto;                 
  }

  /* Affichage graphe */
  .chart-card {
    display: flex;
    flex-direction: column;
  }

  .chart-container {
    position: relative;
    height: 220px;               
    margin-top: 0.75rem;
  }

  .chart-container canvas {
    position: absolute;
    inset: 0;                    
  }

  /* calendrier */
  .calendar-grid {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-width: 520px;
    margin-left: auto;
    margin-right: auto;
    padding: 1.25rem;
    background: rgba(15,23,42,0.6);
    border-radius: 20px;
    border: 1px solid rgba(99,102,241,0.15);
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }

  .calendar-week-header,
  .calendar-week {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.45rem;
  }

  .calendar-week-header span {
    font-size: 0.7rem;
    text-align: center;
    color: #94a3b8;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .calendar-day {
    width: 100%;
    height: 48px;
    border-radius: 50%;
    padding: 0;
    font-size: 0.85rem;
    border: 2px solid rgba(51,65,85,0.5);
    background: radial-gradient(circle at 30% 30%, 
                rgba(51,65,85,0.6), 
                rgba(30,41,59,0.8));
    color: #94a3b8;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.2rem;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: visible;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.03),
                inset 0 -2px 4px rgba(0,0,0,0.2);
  }

  /* Halo lumineux moderne */
  .calendar-day::before {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, 
                transparent 0deg,
                rgba(99,102,241,0.5) 90deg,
                transparent 180deg,
                rgba(168,85,247,0.5) 270deg,
                transparent 360deg);
    opacity: 0;
    transition: all 0.35s ease;
    animation: spin 4s linear infinite;
    filter: blur(8px);
  }

  .calendar-day:hover::before {
    opacity: 1;
    inset: -5px;
    filter: blur(12px);
  }

  .calendar-day:hover {
    transform: translateY(-4px);
    border-color: rgba(99,102,241,0.8);
    box-shadow: 0 12px 32px rgba(99,102,241,0.4),
                0 0 24px rgba(99,102,241,0.2),
                inset 0 2px 6px rgba(255,255,255,0.08);
    background: radial-gradient(circle at 30% 30%, 
                rgba(71,85,105,0.8), 
                rgba(51,65,85,0.9));
    color: #f1f5f9;
  }

  .calendar-day-out {
    opacity: 0.2;
    background: radial-gradient(circle at 30% 30%, 
                rgba(30,41,59,0.3), 
                rgba(15,23,42,0.4));
    border-color: rgba(30,41,59,0.3);
    pointer-events: none;
    box-shadow: none;
  }

  /* JOURS AVEC WORKOUT - Design */
  .calendar-day-has {
    color: #fff;
    background: radial-gradient(circle at 30% 30%, 
                rgba(96,165,250,0.7),
                rgba(59,130,246,0.6) 40%,
                rgba(37,99,235,0.5) 70%,
                rgba(29,78,216,0.4));
    border-color: rgba(147,197,253,0.8);
    font-weight: 800;
    box-shadow: 0 6px 24px rgba(59,130,246,0.5),
                0 0 32px rgba(59,130,246,0.3),
                inset 0 3px 8px rgba(255,255,255,0.25),
                inset 0 -3px 8px rgba(0,0,0,0.3);
    position: relative;
  }

  .calendar-day-has::before {
    background: conic-gradient(from 0deg, 
                rgba(34,197,94,0.8) 0deg,
                rgba(59,130,246,0.8) 120deg,
                rgba(168,85,247,0.8) 240deg,
                rgba(34,197,94,0.8) 360deg);
    inset: -4px;
    opacity: 0.7;
  }

  .calendar-day-has:hover {
    transform: translateY(-6px) scale(1.05);
    border-color: rgba(147,197,253,1);
    box-shadow: 0 16px 48px rgba(59,130,246,0.7),
                0 0 64px rgba(34,197,94,0.4),
                0 0 0 3px rgba(147,197,253,0.3),
                inset 0 4px 12px rgba(255,255,255,0.3);
    background: radial-gradient(circle at 30% 30%, 
                rgba(125,211,252,0.8),
                rgba(59,130,246,0.7) 40%,
                rgba(37,99,235,0.6) 70%,
                rgba(29,78,216,0.5));
  }

  .calendar-day-has:hover::before {
    inset: -6px;
    opacity: 1;
    filter: blur(16px);
  }

  /* TODAY - Design N√©on */
  .calendar-day-today {
    border-color: rgba(251,113,133,1);
    background: radial-gradient(circle at 30% 30%, 
                rgba(251,113,133,0.6),
                rgba(236,72,153,0.5) 50%,
                rgba(219,39,119,0.4));
    box-shadow: 0 0 0 3px rgba(236,72,153,0.25),
                0 6px 24px rgba(236,72,153,0.5),
                0 0 40px rgba(236,72,153,0.3),
                inset 0 2px 6px rgba(255,255,255,0.3);
    color: #fff;
    font-weight: 800;
    animation: todayPulse 3s ease-in-out infinite;
  }

  .calendar-day-today::before {
    background: conic-gradient(from 0deg, 
                rgba(236,72,153,0.9) 0deg,
                rgba(219,39,119,0.9) 180deg,
                rgba(236,72,153,0.9) 360deg);
    opacity: 0.5;
    animation: spin 3s linear infinite;
  }

  .calendar-day-today:hover {
    box-shadow: 0 0 0 4px rgba(236,72,153,0.4), 
                0 12px 40px rgba(236,72,153,0.7),
                0 0 64px rgba(236,72,153,0.5);
  }

  .calendar-day-today:hover::before {
    opacity: 1;
    inset: -6px;
    filter: blur(16px);
  }

  /* SELECTED - Design Cristallin */
  .calendar-day-selected {
    border-color: rgba(192,132,252,1) !important;
    background: radial-gradient(circle at 30% 30%, 
                rgba(216,180,254,0.9),
                rgba(192,132,252,0.8) 40%,
                rgba(168,85,247,0.7) 70%,
                rgba(147,51,234,0.6)) !important;
    color: #fff !important;
    font-weight: 900 !important;
    transform: translateY(-7px) scale(1.12);
    box-shadow: 0 20px 60px rgba(168,85,247,0.8),
                0 0 80px rgba(168,85,247,0.6),
                0 0 0 4px rgba(216,180,254,0.5),
                inset 0 4px 16px rgba(255,255,255,0.4),
                inset 0 -4px 12px rgba(126,34,206,0.4);
    animation: selectedFloat 2.5s ease-in-out infinite, selectedShine 2s ease-in-out infinite;
  }

  .calendar-day-selected::before {
    opacity: 1 !important;
    background: conic-gradient(from 0deg, 
                rgba(168,85,247,1) 0deg,
                rgba(236,72,153,1) 90deg,
                rgba(59,130,246,1) 180deg,
                rgba(34,197,94,1) 270deg,
                rgba(168,85,247,1) 360deg);
    inset: -8px !important;
    filter: blur(20px);
    animation: spin 2s linear infinite;
  }

  .calendar-day-number {
    line-height: 1;
    font-weight: 800;
    z-index: 2;
    font-size: 0.9rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    letter-spacing: -0.02em;
  }

  /* Badge Workout - Style Cristal Lumineux */
  .calendar-day-workout-badge {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: radial-gradient(circle at 35% 35%, 
                #d9f99d,
                #a3e635 30%,
                #4ade80 60%,
                #22c55e);
    border: 1.5px solid rgba(255,255,255,0.4);
    box-shadow: 0 0 16px rgba(34,197,94,1),
                0 0 32px rgba(34,197,94,0.7),
                0 0 48px rgba(34,197,94,0.4),
                inset 0 2px 3px rgba(255,255,255,0.7),
                inset 0 -1px 2px rgba(0,0,0,0.3);
    z-index: 3;
    animation: energyOrb 2.5s ease-in-out infinite;
  }

  .calendar-day-has:hover .calendar-day-workout-badge {
    animation: energyOrbActive 1s ease-in-out infinite;
    width: 11px;
    height: 11px;
    box-shadow: 0 0 24px rgba(34,197,94,1),
                0 0 48px rgba(34,197,94,0.9),
                0 0 72px rgba(34,197,94,0.6),
                inset 0 2px 4px rgba(255,255,255,0.9);
  }

  .calendar-day-selected .calendar-day-workout-badge {
    background: radial-gradient(circle at 35% 35%, 
                #fde68a,
                #fcd34d 30%,
                #fbbf24 60%,
                #f59e0b);
    border-color: rgba(255,255,255,0.6);
    box-shadow: 0 0 20px rgba(245,158,11,1),
                0 0 40px rgba(245,158,11,0.8),
                0 0 60px rgba(245,158,11,0.5);
  }

  /* Animations Avanc√©es */
  @keyframes rotateGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  @keyframes todayPulse {
    0%, 100% { 
      box-shadow: 0 0 0 2px rgba(236,72,153,0.3),
                  0 4px 16px rgba(236,72,153,0.4);
    }
    50% { 
      box-shadow: 0 0 0 4px rgba(236,72,153,0.5),
                  0 6px 24px rgba(236,72,153,0.6),
                  0 0 40px rgba(236,72,153,0.3);
    }
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes selectedShine {
    0%, 100% { 
      filter: brightness(1) saturate(1);
    }
    50% { 
      filter: brightness(1.15) saturate(1.2);
    }
  }

  @keyframes selectedFloat {
    0%, 100% { 
      transform: translateY(-7px) scale(1.12);
    }
    50% { 
      transform: translateY(-9px) scale(1.13);
    }
  }

  @keyframes energyOrb {
    0%, 100% { 
      transform: scale(1);
      box-shadow: 0 0 12px rgba(34,197,94,1),
                  0 0 24px rgba(34,197,94,0.6),
                  0 0 36px rgba(34,197,94,0.3);
    }
    50% { 
      transform: scale(1.2);
      box-shadow: 0 0 16px rgba(34,197,94,1),
                  0 0 32px rgba(34,197,94,0.8),
                  0 0 48px rgba(34,197,94,0.5);
    }
  }

  @keyframes energyOrbActive {
    0%, 100% { 
      transform: scale(1.1) rotate(0deg);
    }
    50% { 
      transform: scale(1.3) rotate(180deg);
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes shimmer {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }

  .calendar-details-panel {
    animation: fadeInUp 0.4s ease;
  }
</style>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem">
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Calories Consomm√©es</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--text)">{{ calories_consumed }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">Prot√©ines : {{ protein_consumed }}g</p>
  </div>
  
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.15));border:1px solid rgba(239,68,68,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Calories Br√ªl√©es</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--danger)">{{ calories_burned }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">S√©ances : {{ sessions_count }}</p>
  </div>
  
  {% if calorie_balance > 0 %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.15));border:1px solid rgba(16,185,129,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--success)">+{{ calorie_balance|floatformat:0 }}</p>
  {% elif calorie_balance < 0 %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));border:1px solid rgba(245,158,11,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--warning)">{{ calorie_balance|floatformat:0 }}</p>
  {% else %}
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Balance Calorique</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--text)">{{ calorie_balance|floatformat:0 }}</p>
  {% endif %}
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">
      {% if calorie_balance > 0 %}Surplus{% elif calorie_balance < 0 %}D√©ficit{% else %}√âquilibre{% endif %}
    </p>
  </div>
  
  <div class="stat-card" style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.15));border:1px solid rgba(236,72,153,0.3)">
    <h3 style="margin:0 0 0.5rem;font-size:0.9rem;opacity:0.9;color:var(--text)">Volume (7 jours)</h3>
    <p style="font-size:2.5rem;margin:0;font-weight:bold;color:var(--accent)">{{ weekly_volume|floatformat:0 }}</p>
    <p style="margin:0.5rem 0 0;opacity:0.8;font-size:0.85rem;color:var(--text-dim)">kg √ó reps</p>
  </div>
</div>


<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:2rem">
  <!-- S√©ances par semaine -->
  <div class="card">
    <h3 style="margin:0 0 .5rem;font-size:.9rem;color:var(--text-dim)">S√©ances (7 derniers jours)</h3>
    <p style="margin:0;font-size:1.6rem;font-weight:700;color:var(--text)">
      {{ week_sessions_current }}
    </p>
    <p style="margin:.3rem 0 0;font-size:.85rem;color:var(--text-dim)">
      Semaine pr√©c√©dente : {{ week_sessions_previous }}
      {% if week_sessions_diff > 0 %}
        <span style="color:var(--success)">(+{{ week_sessions_diff }})</span>
      {% elif week_sessions_diff < 0 %}
        <span style="color:var(--danger)">({{ week_sessions_diff }})</span>
      {% else %}
        <span>(inchang√©)</span>
      {% endif %}
    </p>
  </div>

  <!-- Volume -->
  <div class="card">
    <h3 style="margin:0 0 .5rem;font-size:.9rem;color:var(--text-dim)">Volume (7 jours)</h3>
    <p style="margin:0;font-size:1.6rem;font-weight:700;color:var(--text)">
      {{ week_volume_current|floatformat:0 }} kg
    </p>
    <p style="margin:.3rem 0 0;font-size:.85rem;color:var(--text-dim)">
      Semaine pr√©c√©dente : {{ week_volume_previous|floatformat:0 }} kg
      {% if week_volume_diff > 0 %}
        <span style="color:var(--success)">(+{{ week_volume_diff|floatformat:0 }} kg)</span>
      {% elif week_volume_diff < 0 %}
        <span style="color:var(--danger)">({{ week_volume_diff|floatformat:0 }} kg)</span>
      {% else %}
        <span>(inchang√©)</span>
      {% endif %}
    </p>
  </div>

  <!-- Temps d'entra√Ænement -->
  <div class="card">
    <h3 style="margin:0 0 .5rem;font-size:.9rem;color:var(--text-dim)">Temps d'entra√Ænement (7 jours)</h3>
    <p style="margin:0;font-size:1.6rem;font-weight:700;color:var(--text)">
      {{ week_training_time_current }} min
    </p>
    <p style="margin:.3rem 0 0;font-size:.85rem;color:var(--text-dim)">
      Semaine pr√©c√©dente : {{ week_training_time_previous }} min
      {% if week_training_time_diff > 0 %}
        <span style="color:var(--success)">(+{{ week_training_time_diff }} min)</span>
      {% elif week_training_time_diff < 0 %}
        <span style="color:var(--danger)">({{ week_training_time_diff }} min)</span>
      {% else %}
        <span>(inchang√©)</span>
      {% endif %}
    </p>
  </div>

  <!-- Calories br√ªl√©es -->
  <div class="card">
    <h3 style="margin:0 0 .5rem;font-size:.9rem;color:var(--text-dim)">Calories br√ªl√©es (7 jours)</h3>
    <p style="margin:0;font-size:1.6rem;font-weight:700;color:var(--text)">
      {{ week_calories_current|floatformat:0 }} kcal
    </p>
    <p style="margin:.3rem 0 0;font-size:.85rem;color:var(--text-dim)">
      Semaine pr√©c√©dente : {{ week_calories_previous|floatformat:0 }} kcal
      {% if week_calories_diff > 0 %}
        <span style="color:var(--success)">(+{{ week_calories_diff|floatformat:0 }} kcal)</span>
      {% elif week_calories_diff < 0 %}
        <span style="color:var(--danger)">({{ week_calories_diff|floatformat:0 }} kcal)</span>
      {% else %}
        <span>(inchang√©)</span>
      {% endif %}
    </p>
  </div>
</div>

<div class="card" style="margin-bottom:2rem;display:flex;justify-content:space-between;align-items:center;gap:1.5rem">
  <div>
    <h3 style="margin:0 0 .5rem;font-size:1rem;color:var(--text)">Streak d'entra√Ænement</h3>
    <p style="margin:0;font-size:2rem;font-weight:800;color:var(--accent)">
      {{ current_streak }} <span style="font-size:1rem;font-weight:500;color:var(--text-dim)">jour(s)</span>
    </p>
    <p style="margin:.4rem 0 0;font-size:.85rem;color:var(--text-dim)">
      Meilleur streak : <strong>{{ best_streak }}</strong> jour(s)
    </p>
  </div>

  <div style="text-align:right">
    <h4 style="margin:0 0 .25rem;font-size:.95rem;color:var(--text)">Assiduit√© ce mois-ci</h4>
    <p style="margin:0;font-size:1.6rem;font-weight:700;color:var(--success)">
      {{ monthly_consistency }}%
    </p>
    <p style="margin:.3rem 0 0;font-size:.8rem;color:var(--text-dim)">
      Jours actifs : {{ active_days_this_month }} / {{ days_passed_in_month }}
    </p>
  </div>
</div>


<!-- Graphiques Analytics -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem">   
  <div class="card">
    <h3>Workouts par Semaine (5 derni√®res)</h3>
    <div class="chart-container">
      <canvas id="weeklyWorkoutsChart"></canvas>
    </div>
  </div>

  <div class="card">
    <h3>Calories Journali√®res (7 derniers jours)</h3>
    <div class="chart-container">
      <canvas id="dailyCaloriesChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <h3>Volume d'Entra√Ænement (5 derni√®res semaines)</h3>
    <div class="chart-container">
      <canvas id="weeklyVolumeChart"></canvas>
    </div>
  </div>
  
  <div class="card">
    <h3>R√©partition Macros (Aujourd'hui)</h3>
    <div class="chart-container">
      <canvas id="macrosChart"></canvas>
    </div>
  </div>

  <div class="card">
    <h3>Volume par groupe musculaire (30 derniers jours)</h3>
    <div class="chart-container">
      <canvas id="muscleRadarChart"></canvas>
    </div>
  </div>
</div>

{% if calendar_weeks %}
<div class="card" style="
  margin-bottom:2rem; 
  background: linear-gradient(145deg, rgba(15,23,42,0.95) 0%, rgba(11,13,16,0.98) 100%); 
  border: 2px solid transparent;
  background-image: linear-gradient(145deg, rgba(15,23,42,0.95), rgba(11,13,16,0.98)),
                    linear-gradient(135deg, rgba(99,102,241,0.3), rgba(168,85,247,0.3), rgba(236,72,153,0.3));
  background-origin: border-box;
  background-clip: padding-box, border-box;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4),
              0 0 0 1px rgba(99,102,241,0.1),
              inset 0 1px 0 rgba(255,255,255,0.05);
  backdrop-filter: blur(10px);
">
  <div style="text-align: center; margin-bottom: 0.5rem;">
    <h3 style="
      margin:0 0 0.5rem; 
      font-size: 1.4rem; 
      background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
      background-size: 200% auto;
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
      font-weight: 900;
      letter-spacing: -0.02em;
      text-shadow: 0 0 30px rgba(99,102,241,0.3);
      animation: shimmer 3s linear infinite;
    ">
      üìÖ Calendrier des Workouts
    </h3>
    <p style="
      color: #94a3b8; 
      font-size: 0.8rem; 
      margin: 0; 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
    ">
       <a href="?year={{ prev_month_year }}&month={{ prev_month_month }}"
         style="color:#9ca3af;text-decoration:none;padding:0.2rem 0.5rem;border-radius:999px;border:1px solid #374151;margin-right:0.5rem;">
        ‚Äπ Mois pr√©c√©dent
      </a>

      <span style="color:#e5e7eb;font-weight:700;margin:0 0.5rem;">
        {{ current_month_label }}
      </span>

      <a href="?year={{ next_month_year }}&month={{ next_month_month }}"
         style="color:#9ca3af;text-decoration:none;padding:0.2rem 0.5rem;border-radius:999px;border:1px solid #374151;margin-left:0.5rem;">
        Mois suivant ‚Ä∫
      </a>
    </p>
  </div>

  <!-- Grille du calendrier -->
  <div class="calendar-grid">
    <!-- En-t√™te des jours -->
    <div class="calendar-week-header">
      <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
    </div>

    {% for week in calendar_weeks %}
      <div class="calendar-week">
        {% for day in week %}
          <button
            type="button"
            class="calendar-day
                   {% if not day.in_month %} calendar-day-out{% endif %}
                   {% if day.has_workout %} calendar-day-has{% endif %}
                   {% if day.is_today %} calendar-day-today{% endif %}"
            data-date="{{ day.date|date:'Y-m-d' }}"
          >
            <span class="calendar-day-number">{{ day.day }}</span>
            {% if day.has_workout %}
              <span class="calendar-day-workout-badge"></span>
            {% endif %}
          </button>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- Zone d'affichage des s√©ances du jour s√©lectionn√© -->
  <div id="calendar-details-container" style="
    margin-top:1.5rem; 
    padding-top: 1.5rem; 
    border-top: 2px solid transparent;
    border-image: linear-gradient(90deg, transparent, rgba(99,102,241,0.3), transparent) 1;
  ">
    <div style="
      color:#94a3b8;
      font-size:0.8rem;
      margin:0 0 1rem; 
      text-align: center; 
      font-weight: 600;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(168,85,247,0.1));
      border-radius: 10px;
      border: 1px solid rgba(99,102,241,0.2);
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.05);
    ">
      ‚ú® Les jours avec orbe vert lumineux üü¢ contiennent des workouts
    </div>

    <!-- Message quand aucun workout ce jour-l√† -->
    <div id="calendar-empty-message"
         style="
           display:none;
           color:#fb7185;
           font-size:0.9rem;
           margin-bottom:1rem; 
           text-align: center; 
           padding: 1rem 1.25rem; 
           background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1)); 
           border-radius: 12px; 
           border: 2px solid rgba(239,68,68,0.3);
           box-shadow: 0 4px 12px rgba(239,68,68,0.2),
                       inset 0 1px 2px rgba(255,255,255,0.05);
           font-weight: 600;
           backdrop-filter: blur(8px);
         ">
    </div>

    <!-- Panneaux de d√©tails (un par jour avec au moins une s√©ance) -->
    {% for week in calendar_weeks %}
      {% for day in week %}
        {% if day.sessions %}
          <div class="calendar-details-panel"
               id="details-{{ day.date|date:'Y-m-d' }}"
               style="display:none; animation: fadeInUp 0.4s ease;">

            <!-- Titre du jour -->
            <div style="
              font-size:1rem;
              color:#f3f4f6;
              margin-bottom:1rem; 
              font-weight: 800; 
              padding: 0.75rem 1rem;
              background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(139,92,246,0.15));
              border-radius: 10px;
              border-left: 4px solid rgba(168,85,247,0.8);
              box-shadow: 0 2px 8px rgba(168,85,247,0.2);
              text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            ">
              üóìÔ∏è {{ day.date|date:"l d M Y" }}
            </div>

            {% for session in day.sessions %}
              <div style="
                  border: 2px solid rgba(99,102,241,0.3);
                  border-radius:14px;
                  padding:1rem 1.15rem;
                  margin-bottom:1rem;
                  background: linear-gradient(145deg, 
                              rgba(59,130,246,0.12) 0%, 
                              rgba(99,102,241,0.08) 50%,
                              rgba(30,41,59,0.4) 100%);
                  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                  cursor: pointer;
                  position: relative;
                  overflow: hidden;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.2),
                              inset 0 1px 0 rgba(255,255,255,0.08);
                  backdrop-filter: blur(10px);
                " 
                onmouseover="this.style.borderColor='rgba(99,102,241,0.8)'; this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 32px rgba(99,102,241,0.4), 0 0 0 1px rgba(99,102,241,0.3), inset 0 1px 0 rgba(255,255,255,0.12)'"
                onmouseout="this.style.borderColor='rgba(99,102,241,0.3)'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.08)'">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.65rem;">
                  <div style="flex: 1;">
                    <div style="
                      font-size: 1rem; 
                      font-weight: 800; 
                      color: #f3f4f6; 
                      margin-bottom: 0.35rem;
                      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                      letter-spacing: -0.01em;
                    ">
                      {% if session.from_template %}
                        üí™ {{ session.from_template.name }}
                      {% else %}
                        üí™ S√©ance du {{ session.date|date:"d/m/Y" }}
                      {% endif %}
                    </div>
                    <div style="
                      font-size:0.8rem;
                      color:#94a3b8; 
                      display: flex; 
                      gap: 1rem; 
                      align-items: center;
                      font-weight: 600;
                    ">
                      <span style="display:flex;align-items:center;gap:0.3rem;">üìÜ {{ session.date|date:"l d M" }}</span>
                      <span style="display:flex;align-items:center;gap:0.3rem;">‚è±Ô∏è {{ session.duration_minutes }} min</span>
                    </div>
                  </div>
                  <div style="
                    background: linear-gradient(135deg, rgba(249,115,22,0.3) 0%, rgba(234,88,12,0.25) 100%);
                    border: 2px solid rgba(249,115,22,0.5);
                    padding: 0.5rem 0.85rem;
                    border-radius: 10px;
                    font-size:0.8rem;
                    font-weight: 800;
                    color:#fed7aa;
                    white-space: nowrap;
                    box-shadow: 0 4px 12px rgba(249,115,22,0.3),
                                inset 0 1px 2px rgba(255,255,255,0.2);
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                  ">
                    üî• {{ session.estimated_calories_burned }}
                  </div>
                </div>

                <div style="
                    margin-top:0.75rem;
                    display:flex;
                    justify-content:space-between;
                    align-items:center;
                    padding-top: 0.75rem;
                    border-top: 2px solid rgba(99,102,241,0.2);
                  ">
                  <div style="
                    font-size:0.85rem;
                    color:#cbd5e1;
                    font-weight: 700;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                  ">
                    üìä Volume: <strong style="
                      color: #c4b5fd;
                      background: linear-gradient(135deg, #a78bfa, #c4b5fd);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                    ">{{ session.total_volume|floatformat:0 }} kg</strong>
                  </div>
                  <a href="{% url 'workouts:session_summary' session.pk %}"
                     class="btn"
                     style="
                       padding:0.5rem 1rem;
                       font-size:0.8rem;
                       background: linear-gradient(135deg, rgba(168,85,247,0.9) 0%, rgba(139,92,246,0.9) 100%);
                       border: 2px solid rgba(192,132,252,0.5);
                       transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                       font-weight: 700;
                       box-shadow: 0 4px 12px rgba(168,85,247,0.4),
                                   inset 0 1px 2px rgba(255,255,255,0.2);
                       text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                     "
                     onmouseover="this.style.background='linear-gradient(135deg, rgba(168,85,247,1) 0%, rgba(139,92,246,1) 100%)'; this.style.transform='scale(1.08) translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(168,85,247,0.6), 0 0 0 2px rgba(192,132,252,0.4)'"
                     onmouseout="this.style.background='linear-gradient(135deg, rgba(168,85,247,0.9) 0%, rgba(139,92,246,0.9) 100%)'; this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 4px 12px rgba(168,85,247,0.4), inset 0 1px 2px rgba(255,255,255,0.2)'">
                    D√©tails ‚Üí
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
</div>
{% endif %}


<div class="card" style="margin-top:2rem;margin-bottom:2rem">
  <h3 style="margin:0 0 1rem;font-size:1.1rem;color:var(--text)">
    üìÜ R√©sum√© du mois de {{ today|date:"F Y" }}
  </h3>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;font-size:.9rem">
    <div>
      <div style="color:var(--text-dim);margin-bottom:.2rem">S√©ances compl√©t√©es</div>
      <div style="font-size:1.5rem;font-weight:700">{{ month_sessions_count }}</div>
    </div>
    <div>
      <div style="color:var(--text-dim);margin-bottom:.2rem">Temps total</div>
      <div style="font-size:1.5rem;font-weight:700">
        {{ month_total_duration }} min
      </div>
    </div>
    <div>
      <div style="color:var(--text-dim);margin-bottom:.2rem">Volume total</div>
      <div style="font-size:1.5rem;font-weight:700">
        {{ month_total_volume|floatformat:0 }} kg
      </div>
    </div>
    <div>
      <div style="color:var(--text-dim);margin-bottom:.2rem">Calories br√ªl√©es</div>
      <div style="font-size:1.5rem;font-weight:700">
        {{ month_total_calories_burned|floatformat:0 }} kcal
      </div>
    </div>
    <div>
      <div style="color:var(--text-dim);margin-bottom:.2rem">PR obtenus</div>
      <div style="font-size:1.5rem;font-weight:700">
        {{ month_prs_count }}
      </div>
    </div>
  </div>
</div>


{% if best_prs_grouped %}
<div class="card" style="margin-top:1.5rem;">
  <h3>üèãÔ∏è Mes PR par exercice</h3>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem;">
    {% for ex in best_prs_grouped %}
    <div style="
         padding:0.9rem 1rem;
         border-radius:12px;
         border:1px solid rgba(99,102,241,0.35);
         background:linear-gradient(145deg,rgba(15,23,42,0.9),rgba(17,24,39,0.95));
         box-shadow:0 4px 16px rgba(0,0,0,0.35);
       ">
      <div style="font-weight:700;color:#e5e7eb;margin-bottom:0.4rem;font-size:0.95rem;">
        {{ ex.exercise }}
      </div>
      <ul style="list-style:none;margin:0;padding:0;font-size:0.85rem;color:#cbd5e1;">
        {% for pr in ex.prs %}
        <li style="margin-bottom:0.25rem;">
          <span style="opacity:0.9;">{{ pr.metric_label }} :</span>
          <strong style="margin-left:0.25rem;">{{ pr.value }}</strong>
          <span style="opacity:0.7;">( {{ pr.date|date:"d/m/Y" }} )</span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>
</div>
{% else %}
<div class="card" style="margin-top:1.5rem;">
  <h3>üèãÔ∏è Mes PR par exercice</h3>
  <p style="font-size:0.9rem;color:#9ca3af;margin-top:0.5rem;">
    Aucun PR enregistr√© pour l‚Äôinstant.  
    Les records appara√Ætront ici d√®s que des PR seront cr√©√©s √† partir de tes s√©ances.
  </p>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const days = document.querySelectorAll('.calendar-day');
  const panels = document.querySelectorAll('.calendar-details-panel');
  const emptyMsg = document.getElementById('calendar-empty-message');

  // Cache tous les panneaux de d√©tails
  function hideAllPanels() {
    panels.forEach(p => p.style.display = 'none');
  }

  // Enl√®ve le highlight de tous les jours
  function clearSelectedDays() {
    days.forEach(d => d.classList.remove('calendar-day-selected'));
  }

  days.forEach(btn => {
    btn.addEventListener('click', () => {
      const date = btn.dataset.date;   // ex: "2025-11-13"

      clearSelectedDays();
      btn.classList.add('calendar-day-selected');

      hideAllPanels();

      const panel = document.getElementById('details-' + date);

      if (panel) {
        // Il y a des s√©ances ce jour-l√†
        if (emptyMsg) {
          emptyMsg.style.display = 'none';
          emptyMsg.textContent = '';
        }
        panel.style.display = 'block';
      } else {
        // Aucune s√©ance ce jour-l√†
        if (emptyMsg) {
          emptyMsg.innerHTML = "üò¥ Pas de s√©ance d'entra√Ænement ce jour-l√†";
          emptyMsg.style.display = 'block';
        }
      }
    });
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Configuration globale Chart.js
Chart.defaults.color = '#9ca3af';
Chart.defaults.borderColor = 'rgba(99,102,241,0.1)';
Chart.defaults.font.family = "'Inter', sans-serif";

// 1. Workouts par Semaine
const weeklyWorkoutsCtx = document.getElementById('weeklyWorkoutsChart');
if (weeklyWorkoutsCtx) {  // s√©curit√© : on v√©rifie que le canvas existe
  new Chart(weeklyWorkoutsCtx, {
    type: 'bar',
    data: {
      labels: {{ weekly_workouts_labels|safe }},
      datasets: [{
        label: 'Workouts',
        data: {{ weekly_workouts_data|safe }},
        backgroundColor: 'rgba(99,102,241,0.6)',
        borderColor: 'rgba(99,102,241,0.8)',
        borderWidth: 2,
        borderRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(99,102,241,0.3)',
          borderWidth: 1,
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          grid: { color: 'rgba(99,102,241,0.1)' }
        },
        x: { grid: { display: false } }
      }
    }
  });
}

// 2. Calories Journali√®res
const dailyCaloriesCtx = document.getElementById('dailyCaloriesChart');
if (dailyCaloriesCtx) {
  console.log("daily labels =", {{ daily_calories_labels|safe }});
  console.log("daily consumed =", {{ daily_calories_consumed|safe }});
  console.log("daily burned =", {{ daily_calories_burned|safe }});

  new Chart(dailyCaloriesCtx, {
    type: 'line',
    data: {
      labels: {{ daily_calories_labels|safe }},
      datasets: [{
        label: 'Consomm√©es',
        data: {{ daily_calories_consumed|safe }},
        borderColor: 'rgba(99,102,241,0.8)',
        backgroundColor: 'rgba(99,102,241,0.2)',
        fill: true,
        tension: 0.4,
      }, {
        label: 'Br√ªl√©es',
        data: {{ daily_calories_burned|safe }},
        borderColor: 'rgba(239,68,68,0.8)',
        backgroundColor: 'rgba(239,68,68,0.2)',
        fill: true,
        tension: 0.4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(99,102,241,0.3)',
          borderWidth: 1,
        }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' } },
        x: { grid: { display: false } }
      }
    }
  });
}

// 3. Volume Hebdomadaire
const weeklyVolumeCtx = document.getElementById('weeklyVolumeChart');
if (weeklyVolumeCtx) {
  console.log("weekly volume labels =", {{ weekly_volume_labels|safe }});
  console.log("weekly volume data =", {{ weekly_volume_data|safe }});

  new Chart(weeklyVolumeCtx, {
    type: 'line',
    data: {
      labels: {{ weekly_volume_labels|safe }},
      datasets: [{
        label: 'Volume (kg)',
        data: {{ weekly_volume_data|safe }},
        borderColor: 'rgba(236,72,153,0.8)',
        backgroundColor: 'rgba(236,72,153,0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(236,72,153,0.3)',
          borderWidth: 1,
        }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(99,102,241,0.1)' } },
        x: { grid: { display: false } }
      }
    }
  });
}

// 4. R√©partition Macros
const macrosCtx = document.getElementById('macrosChart');
if (macrosCtx) {
  console.log("macros =", {{ protein_consumed|default:0 }}, {{ carbs_consumed|default:0 }}, {{ fat_consumed|default:0 }});

  new Chart(macrosCtx, {
    type: 'doughnut',
    data: {
      labels: ['Prot√©ines', 'Glucides', 'Lipides'],
      datasets: [{
        data: [{{ protein_consumed|default:0 }}, {{ carbs_consumed|default:0 }}, {{ fat_consumed|default:0 }}],
        backgroundColor: [
          'rgba(16,185,129,0.6)',
          'rgba(245,158,11,0.6)',
          'rgba(236,72,153,0.6)'
        ],
        borderColor: [
          'rgba(16,185,129,0.8)',
          'rgba(245,158,11,0.8)',
          'rgba(236,72,153,0.8)'
        ],
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } },
        tooltip: {
          backgroundColor: 'rgba(26,26,36,0.95)',
          padding: 12,
          borderColor: 'rgba(99,102,241,0.3)',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + 'g';
            }
          }
        }
      }
    }
  });
}

const radarCtx = document.getElementById('muscleRadarChart');
  if (radarCtx) {
    const labelsRadar = {{ muscle_groups_labels|default:"[]"|safe }};
    const dataRadar = {{ muscle_groups_values|default:"[]"|safe }};

    if (labelsRadar.length > 0) {
      new Chart(radarCtx, {
        type: 'radar',
        data: {
          labels: labelsRadar,
          datasets: [{
            label: 'Volume (kg √ó reps)',
            data: dataRadar,
            borderWidth: 2,
            borderColor: 'rgba(59,130,246,0.9)',
            backgroundColor: 'rgba(59,130,246,0.25)',
            pointRadius: 4,
            pointHoverRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              grid: { color: 'rgba(148,163,184,0.2)' },
              angleLines: { color: 'rgba(148,163,184,0.3)' },
              ticks: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(15,23,42,0.95)',
              borderColor: 'rgba(59,130,246,0.5)',
              borderWidth: 1,
              padding: 10,
            }
          }
        }
      });
    }
  }
</script>
{% endblock %}
