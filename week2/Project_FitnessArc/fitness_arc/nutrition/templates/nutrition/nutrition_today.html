{% extends "base.html" %}
{% block title %}Nutrition ¬∑ {{ current_date|date:"d M" }}{% endblock %}
{% block content %}
<div id="nutritionApp">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
    <div>
      <h1>Nutrition du jour</h1>
      <p style="color:var(--text-dim);margin-top:0.5rem">{{ current_date|date:"l d M Y" }}</p>
    </div>
    <a href="{% url 'recipe_list' %}" class="btn-fancy">
      <i class="bi bi-book"></i>
      Voir les recettes
    </a>
  </div>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1.5rem;margin-bottom:3rem">
    <div class="stat-card" style="background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.15));border:1px solid rgba(99,102,241,0.3)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem;color:var(--text)">Calories</div>
      <div style="font-size:2.5rem;font-weight:700;color:var(--text)" v-text="totals.kcal"></div>
      <div style="font-size:0.8rem;opacity:0.8;color:var(--text-dim)">kcal</div>
    </div>
    
    <div class="stat-card" style="background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.15));border:1px solid rgba(16,185,129,0.3)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem;color:var(--text)">Prot√©ines</div>
      <div style="font-size:2.5rem;font-weight:700;color:var(--success)" v-text="totals.protein"></div>
      <div style="font-size:0.8rem;opacity:0.8;color:var(--text-dim)">grammes</div>
    </div>
    
    <div class="stat-card" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.15));border:1px solid rgba(245,158,11,0.3)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem;color:var(--text)">Glucides</div>
      <div style="font-size:2.5rem;font-weight:700;color:var(--warning)" v-text="totals.carbs"></div>
      <div style="font-size:0.8rem;opacity:0.8;color:var(--text-dim)">grammes</div>
    </div>
    
    <div class="stat-card" style="background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.15));border:1px solid rgba(236,72,153,0.3)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem;color:var(--text)">Lipides</div>
      <div style="font-size:2.5rem;font-weight:700;color:var(--accent)" v-text="totals.fat"></div>
      <div style="font-size:0.8rem;opacity:0.8;color:var(--text-dim)">grammes</div>
    </div>
  </div>

  <div class="card" style="position:relative;z-index:2">
    <h3>Ajouter un aliment</h3>
    <form @submit.prevent="addFood" style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:1rem;margin-top:1.5rem">
      <label>
        Aliment
        <div class="custom-select" data-searchable>
          <select v-model="newLog.food" required id="foodSelect" @change="onFoodChange">
            <option value="">Choisir un aliment...</option>
            <option v-for="food in foods" :key="food.id" :value="food.id" v-text="food.name"></option>
          </select>
        </div>
      </label>
      <label style="position:relative">
        Quantit√© (g,mL,unit√©s) <span v-if="newLog.food" style="color:#6366f1;font-weight:600;font-size:0.75rem">({{ selectedFoodUnit }})</span>
        <input type="number" v-model="newLog.quantity" step="0.1" min="0.1" placeholder="100" required>
      </label>
      <label>
        Repas
        <div class="custom-select">
          <select v-model="newLog.meal_type" required>
            <option value="breakfast">Petit-d√©jeuner</option>
            <option value="lunch">D√©jeuner</option>
            <option value="dinner">D√Æner</option>
            <option value="snack">Collation</option>
          </select>
        </div>
      </label>
      <button type="submit" class="btn-add-food">Ajouter</button>
    </form>
  </div>

  <div v-if="Object.keys(groupedLogs).length > 0" style="margin-top:2rem">
    <h3>Entr√©es du jour</h3>
    
    <div v-for="(logs, mealType) in groupedLogs" :key="mealType" class="meal-group">
      <h4>
        <span v-text="getMealIcon(mealType)"></span>
        <span v-text="getMealLabel(mealType)"></span>
        <span style="margin-left:auto;font-size:0.9rem;font-weight:500;color:var(--primary)" v-text="getMealTotals(logs).kcal + ' kcal'"></span>
      </h4>
      
      <div v-for="log in logs" :key="log.id" class="item-card" style="margin:0.75rem 0">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem">
              <strong style="font-size:1.05rem" v-text="log.food_name"></strong>
              <span style="font-size:0.9rem;color:var(--text-dim)" v-text="log.quantity + ' ' + log.unit"></span>
            </div>
            <div style="display:flex;gap:1.5rem;font-size:0.85rem;color:var(--text-dim)">
              <div><span v-text="log.kcal"></span> kcal</div>
              <div>P: <span v-text="log.protein"></span>g</div>
              <div>G: <span v-text="log.carbs"></span>g</div>
              <div>L: <span v-text="log.fat"></span>g</div>
            </div>
          </div>
          <button @click="deleteLog(log.id)" class="btn btn-danger" style="padding:0.5rem 1rem;font-size:0.85rem">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
  <div v-else class="card" style="text-align:center;padding:3rem;position:relative;z-index:0">
    <p style="color:var(--text-dim)">Aucun aliment ajout√© aujourd'hui</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      foods: {{ foods_json|safe }},
      logs: {{ logs_json|safe }},
      totals: {{ totals_json|safe }},
      newLog: {food: '', quantity: 100, meal_type: 'lunch'}
    }
  },
  computed: {
    groupedLogs() {
      const groups = {};
      const order = ['breakfast', 'lunch', 'dinner', 'snack'];
      this.logs.forEach(log => {
        if (!groups[log.meal_type]) groups[log.meal_type] = [];
        groups[log.meal_type].push(log);
      });
      const sorted = {};
      order.forEach(key => {
        if (groups[key]) sorted[key] = groups[key];
      });
      return sorted;
    },
    selectedFoodUnit() {
      if (!this.newLog.food) return '';
      const food = this.foods.find(f => f.id == this.newLog.food);
      if (!food) return '';
      const unitLabels = {
        'g': 'Grammes (g)',
        'ml': 'Millilitres (ml)',
        'unit': 'Unit√©(s)'
      };
      return unitLabels[food.unit_type] || 'g';
    }
  },
  methods: {
    onFoodChange(event) {
      this.newLog.food = event.target.value;
    },
    async addFood() {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      formData.append('food', this.newLog.food);
      formData.append('quantity', this.newLog.quantity);
      formData.append('meal_type', this.newLog.meal_type);
      
      const response = await fetch('{% url "nutrition_today" %}', {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) location.reload();
    },
    async deleteLog(logId) {
      if (!confirm('Supprimer cet aliment ?')) return;
      const response = await fetch(`/nutrition/delete/${logId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
      });
      if (response.ok) location.reload();
    },
    getMealLabel(type) {
      const labels = {
        breakfast: 'Petit-d√©jeuner',
        lunch: 'D√©jeuner',
        dinner: 'D√Æner',
        snack: 'Collation'
      };
      return labels[type] || type;
    },
    getMealIcon(type) {
      const icons = {
        breakfast: 'üåÖ',
        lunch: 'üçΩÔ∏è',
        dinner: 'üåô',
        snack: 'ü•§'
      };
      return icons[type] || 'üç¥';
    },
    getMealTotals(logs) {
      return {
        kcal: Math.round(logs.reduce((sum, log) => sum + parseFloat(log.kcal), 0))
      };
    }
  },
  mounted() {
    // Initialize custom selects after Vue renders
    this.$nextTick(() => {
      document.querySelectorAll('#nutritionApp .custom-select').forEach(element => {
        const searchable = element.hasAttribute('data-searchable');
        const customSelect = new CustomSelect(element, { searchable });
        
        // Synchroniser le custom select avec Vue
        const select = element.querySelector('select');
        if (select && select.id === 'foodSelect') {
          select.addEventListener('change', (e) => {
            this.newLog.food = e.target.value;
          });
        }
      });
    });
  }
}).mount('#nutritionApp');
</script>
{% endblock %}