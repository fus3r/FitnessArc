{% extends "base.html" %}
{% block title %}Nutrition ¬∑ {{ current_date|date:"d M" }}{% endblock %}
{% block content %}
<div id="nutritionApp">
  <h1>Nutrition du jour</h1>
  <p style="color:var(--text-dim);margin-bottom:2rem">{{ current_date|date:"l d M Y" }}</p>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1.5rem;margin-bottom:3rem">
    <div class="stat-card" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem">Calories</div>
      <div style="font-size:2.5rem;font-weight:700" v-text="totals.kcal"></div>
      <div style="font-size:0.8rem;opacity:0.8">kcal</div>
    </div>
    <div class="stat-card" style="background:linear-gradient(135deg,var(--success),#059669)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem">Prot√©ines</div>
      <div style="font-size:2.5rem;font-weight:700" v-text="totals.protein"></div>
      <div style="font-size:0.8rem;opacity:0.8">grammes</div>
    </div>
    <div class="stat-card" style="background:linear-gradient(135deg,var(--warning),#d97706)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem">Glucides</div>
      <div style="font-size:2.5rem;font-weight:700" v-text="totals.carbs"></div>
      <div style="font-size:0.8rem;opacity:0.8">grammes</div>
    </div>
    <div class="stat-card" style="background:linear-gradient(135deg,var(--accent),#db2777)">
      <div style="font-size:0.85rem;opacity:0.9;margin-bottom:0.5rem">Lipides</div>
      <div style="font-size:2.5rem;font-weight:700" v-text="totals.fat"></div>
      <div style="font-size:0.8rem;opacity:0.8">grammes</div>
    </div>
  </div>

  <div class="card">
    <h3>Ajouter un aliment</h3>
    <form @submit.prevent="addFood" style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:1rem;align-items:end;margin-top:1.5rem">
      <label>
        Aliment
        <select v-model="newLog.food" required style="cursor:pointer">
          <option value="">Choisir un aliment...</option>
          <option v-for="food in foods" :key="food.id" :value="food.id" v-text="food.name"></option>
        </select>
      </label>
      <label>
        Quantit√©
        <input type="number" v-model="newLog.quantity" step="0.1" min="0.1" placeholder="100" required>
      </label>
      <label>
        Repas
        <select v-model="newLog.meal_type" required style="cursor:pointer">
          <option value="breakfast">Petit-d√©jeuner</option>
          <option value="lunch">D√©jeuner</option>
          <option value="dinner">D√Æner</option>
          <option value="snack">Collation</option>
        </select>
      </label>
      <button type="submit" class="btn">Ajouter</button>
    </form>
  </div>

  <div v-if="Object.keys(groupedLogs).length > 0" style="margin-top:2rem">
    <h3>Entr√©es du jour</h3>
    
    <div v-for="(logs, mealType) in groupedLogs" :key="mealType" class="meal-group">
      <h4>
        <span v-text="getMealIcon(mealType)"></span>
        <span v-text="getMealLabel(mealType)"></span>
        <span style="margin-left:auto;font-size:0.9rem;font-weight:500;color:var(--primary)" v-text="getMealTotals(logs).kcal + ' kcal'"></span>
      </h4>
      
      <div v-for="log in logs" :key="log.id" class="item-card" style="margin:0.75rem 0">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.75rem">
              <strong style="font-size:1.05rem" v-text="log.food_name"></strong>
              <span style="font-size:0.9rem;color:var(--text-dim)" v-text="log.quantity + ' ' + log.unit"></span>
            </div>
            <div style="display:flex;gap:1.5rem;font-size:0.85rem;color:var(--text-dim)">
              <div><span v-text="log.kcal"></span> kcal</div>
              <div>P: <span v-text="log.protein"></span>g</div>
              <div>G: <span v-text="log.carbs"></span>g</div>
              <div>L: <span v-text="log.fat"></span>g</div>
            </div>
          </div>
          <button @click="deleteLog(log.id)" class="btn btn-danger" style="padding:0.5rem 1rem;font-size:0.85rem">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
  <div v-else class="card" style="text-align:center;padding:3rem">
    <p style="color:var(--text-dim)">Aucun aliment ajout√© aujourd'hui</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;
createApp({
  data() {
    return {
      foods: {{ foods_json|safe }},
      logs: {{ logs_json|safe }},
      totals: {{ totals_json|safe }},
      newLog: {food: '', quantity: 100, meal_type: 'lunch'}
    }
  },
  computed: {
    groupedLogs() {
      const groups = {};
      const order = ['breakfast', 'lunch', 'dinner', 'snack'];
      this.logs.forEach(log => {
        if (!groups[log.meal_type]) groups[log.meal_type] = [];
        groups[log.meal_type].push(log);
      });
      const sorted = {};
      order.forEach(key => {
        if (groups[key]) sorted[key] = groups[key];
      });
      return sorted;
    }
  },
  methods: {
    async addFood() {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      formData.append('food', this.newLog.food);
      formData.append('quantity', this.newLog.quantity);
      formData.append('meal_type', this.newLog.meal_type);
      
      const response = await fetch('{% url "nutrition_today" %}', {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) location.reload();
    },
    async deleteLog(logId) {
      if (!confirm('Supprimer cet aliment ?')) return;
      const response = await fetch(`/nutrition/delete/${logId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
      });
      if (response.ok) location.reload();
    },
    getMealLabel(type) {
      const labels = {
        breakfast: 'Petit-d√©jeuner',
        lunch: 'D√©jeuner',
        dinner: 'D√Æner',
        snack: 'Collation'
      };
      return labels[type] || type;
    },
    getMealIcon(type) {
      const icons = {
        breakfast: 'üåÖ',
        lunch: 'üçΩÔ∏è',
        dinner: 'üåô',
        snack: 'ü•§'
      };
      return icons[type] || 'üç¥';
    },
    getMealTotals(logs) {
      return {
        kcal: Math.round(logs.reduce((sum, log) => sum + parseFloat(log.kcal), 0))
      };
    }
  }
}).mount('#nutritionApp');
</script>
{% endblock %}